<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®ÂàÜÊûêÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-right: 1px solid #ddd;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        /* Ê®°ÊÄÅÂØπËØùÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        
        .modal-header {
            padding: 20px 25px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        .modal-body {
            padding: 20px 25px;
        }
        
        .modal-footer {
            padding: 15px 25px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
            display: none;
        }
        
        .content.active {
            display: block;
        }
        
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        /* Ëá™ÈÄâËÇ°Âç°ÁâáÊ†∑Âºè */
        .stock-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stock-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stock-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .stock-name-section {
            flex: 1;
        }
        
        .stock-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .price-section {
            margin: 15px 0;
        }
        
        .current-price {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-info-row {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .price-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .price-label {
            color: #666;
            font-size: 0.85em;
        }
        
        .price-value {
            font-weight: bold;
        }
        
        .market-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .cost-info {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .cost-positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .cost-negative {
            background: #ffebee;
            color: #c62828;
        }
        
        .category-label {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .price-up {
            color: #f44336;
        }
        
        .price-down {
            color: #4caf50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà ËÇ°Á•®ÂàÜÊûêÁ≥ªÁªü</h1>
            <p>ÂÆûÊó∂Ë°åÊÉÖ ¬∑ ÊäÄÊúØÂàÜÊûê ¬∑ Êô∫ËÉΩÊé®Ëçê</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('watchlist')">Ëá™ÈÄâËÇ°</div>
            <div class="tab" onclick="switchTab('screen')">Êù°‰ª∂ÈÄâËÇ°</div>
            <div class="tab" onclick="switchTab('quant')">üìä ÈáèÂåñ‰∫§Êòì</div>
            <div class="tab" onclick="switchTab('news')">ÈáëËûçÊñ∞Èóª</div>
            <div class="tab" onclick="switchTab('ai')">AIÂàÜÊûê</div>
            <div class="tab" onclick="switchTab('alert')">‰ª∑Ê†ºÊèêÈÜí</div>
            <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è ËÆæÁΩÆ</div>
        </div>
        
        <!-- Ëá™ÈÄâËÇ° -->
        <div id="watchlist" class="content active">
            <div class="card">
                <h3>Ê∑ªÂä†Ëá™ÈÄâËÇ°</h3>
                <div class="form-group">
                    <label>ËÇ°Á•®‰ª£Á†ÅÔºàÂ¶ÇÔºö000001Ôºâ</label>
                    <input type="text" id="stockCode" placeholder="ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å">
                </div>
                <div class="form-group">
                    <label>ÂàÜÁ±ª</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="categorySelect" style="flex: 1;">
                            <option value="">Âä†ËΩΩ‰∏≠...</option>
                        </select>
                        <button class="btn" onclick="showCreateCategory()">+ Êñ∞Âª∫ÂàÜÁ±ª</button>
                    </div>
                </div>
                <button class="btn" onclick="addToWatchlist()">Ê∑ªÂä†Âà∞Ëá™ÈÄâËÇ°</button>
            </div>
            
            <!-- ÂàõÂª∫ÂàÜÁ±ªÂØπËØùÊ°Ü -->
            <div id="createCategoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div class="card" style="max-width: 500px; width: 90%; margin: 0;">
                    <h3 style="margin-bottom: 20px;">ÂàõÂª∫Êñ∞ÂàÜÁ±ª</h3>
                    <div class="form-group">
                        <label>ÂàÜÁ±ªÂêçÁß∞ *</label>
                        <input type="text" id="categoryName" placeholder="Â¶ÇÔºöÂ∑≤Ë¥≠„ÄÅÈ¢ÑË¥≠„ÄÅÂÖ≥Ê≥®">
                    </div>
                    <div class="form-group">
                        <label>ÊèèËø∞</label>
                        <input type="text" id="categoryDesc" placeholder="ÂàÜÁ±ªÊèèËø∞ÔºàÂèØÈÄâÔºâ">
                    </div>
                    <div class="form-group">
                        <label>È¢úËâ≤</label>
                        <input type="color" id="categoryColor" value="#1890ff">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="createCategory()">ÂàõÂª∫</button>
                        <button class="btn" style="background: #6c757d;" onclick="hideCreateCategory()">ÂèñÊ∂à</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0;">ÊàëÁöÑËá™ÈÄâËÇ°</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">
                            Ëá™Âä®Âà∑Êñ∞: <span id="refreshStatus">Â∑≤ÂêØÁî®</span> | 
                            Èó¥Èöî: <span id="refreshInterval">3</span>Áßí
                        </p>
                    </div>
                    <button class="btn" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">‚è∏Ô∏è ÊöÇÂÅú</button>
                </div>
                <div id="watchlistList" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <!-- Êù°‰ª∂ÈÄâËÇ° -->
        <div id="screen" class="content">
            <div class="card">
                <h3>ÈÄâËÇ°Êù°‰ª∂Ê®°Êùø</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <select id="templateSelect" style="flex: 1;">
                        <option value="">ÈÄâÊã©Ê®°Êùø...</option>
                    </select>
                    <button class="btn" onclick="loadTemplate()" style="background: #28a745;">üìÇ Âä†ËΩΩ</button>
                    <button class="btn" onclick="showSaveTemplateDialog()" style="background: #17a2b8;">üíæ ‰øùÂ≠ò</button>
                    <button class="btn" onclick="editTemplate()" style="background: #ffc107; color: #000;">‚úèÔ∏è ÁºñËæë</button>
                    <button class="btn" onclick="deleteTemplate()" style="background: #dc3545;">üóëÔ∏è Âà†Èô§</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ËÆæÁΩÆÈÄâËÇ°Êù°‰ª∂</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Â∏ÇÂú∫</label>
                        <select id="market">
                            <option value="">ÂÖ®ÈÉ®Â∏ÇÂú∫</option>
                            <option value="SH">‰∏äÊµ∑Â∏ÇÂú∫</option>
                            <option value="SZ">Ê∑±Âú≥Â∏ÇÂú∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>‰ª∑Ê†ºÂå∫Èó¥ÔºàÂÖÉÔºâ</label>
                        <input type="number" id="minPrice" placeholder="ÊúÄ‰Ωé‰ª∑">
                        <input type="number" id="maxPrice" placeholder="ÊúÄÈ´ò‰ª∑" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Ê∂®Ë∑åÂπÖÔºà%Ôºâ</label>
                        <input type="number" id="minChange" placeholder="ÊúÄ‰ΩéÊ∂®ÂπÖ">
                        <input type="number" id="maxChange" placeholder="ÊúÄÈ´òÊ∂®ÂπÖ" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Êç¢ÊâãÁéáÔºà%Ôºâ</label>
                        <input type="number" id="minTurnover" placeholder="ÊúÄ‰ΩéÊç¢ÊâãÁéá">
                        <input type="number" id="maxTurnover" placeholder="ÊúÄÈ´òÊç¢ÊâãÁéá" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Â∏ÇÁõàÁéáÔºàPEÔºâ</label>
                        <input type="number" id="minPE" placeholder="ÊúÄ‰ΩéPE">
                        <input type="number" id="maxPE" placeholder="ÊúÄÈ´òPE" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Â∏ÇÂáÄÁéáÔºàPBÔºâ</label>
                        <input type="number" id="minPB" placeholder="ÊúÄ‰ΩéPB">
                        <input type="number" id="maxPB" placeholder="ÊúÄÈ´òPB" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Êàê‰∫§ÈáèÔºàÊâãÔºâ</label>
                        <input type="number" id="minVolume" placeholder="ÊúÄ‰ΩéÊàê‰∫§Èáè">
                        <input type="number" id="maxVolume" placeholder="ÊúÄÈ´òÊàê‰∫§Èáè" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Â∏ÇÂÄºÂå∫Èó¥Ôºà‰∏áÂÖÉÔºâ</label>
                        <input type="number" id="minMarketValue" placeholder="ÊúÄ‰ΩéÂ∏ÇÂÄº">
                        <input type="number" id="maxMarketValue" placeholder="ÊúÄÈ´òÂ∏ÇÂÄº" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>ËÇ°ÊÅØÁéáÔºà%Ôºâ</label>
                        <input type="number" id="minDividendYield" placeholder="ÊúÄ‰ΩéËÇ°ÊÅØÁéá">
                        <input type="number" id="maxDividendYield" placeholder="ÊúÄÈ´òËÇ°ÊÅØÁéá" style="margin-top: 5px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="screenStocks()" style="flex: 1;">üîç ÂºÄÂßãÈÄâËÇ°</button>
                    <button class="btn" onclick="clearConditions()" style="background: #6c757d;">üßπ Ê∏ÖÁ©∫Êù°‰ª∂</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ÈÄâËÇ°ÁªìÊûú</h3>
                <div id="screenResults" class="loading">Á≠âÂæÖÊü•ËØ¢...</div>
            </div>
        </div>
        
        <!-- ÈáèÂåñ‰∫§Êòì -->
        <div id="quant" class="content">
            <!-- Á≠ñÁï•ÁÆ°ÁêÜ -->
            <div class="card">
                <h3>üìä Á≠ñÁï•ÁÆ°ÁêÜ</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="quantTrading.loadStrategies()">üîÑ Âà∑Êñ∞Á≠ñÁï•</button>
                    <button class="btn" onclick="quantTrading.importDefaultStrategies()" style="background: #28a745;">üì• ÂØºÂÖ•ÈªòËÆ§Á≠ñÁï•</button>
                    <button class="btn" onclick="quantTrading.showCreateStrategy()" style="background: #17a2b8;">‚ûï ÂàõÂª∫Á≠ñÁï•</button>
                </div>
                <div id="strategyList" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>

            <!-- Á≠ñÁï•ÈÖçÁΩÆ -->
            <div class="card">
                <h3>‚öôÔ∏è Á≠ñÁï•ÈÖçÁΩÆ</h3>
                <div class="form-group">
                    <label>ÈÄâÊã©Á≠ñÁï•</label>
                    <select id="strategySelect" onchange="quantTrading.loadStrategyConfig()">
                        <option value="">ËØ∑ÈÄâÊã©Á≠ñÁï•...</option>
                    </select>
                </div>
                <div id="strategyConfigForm" style="display: none;">
                    <div class="form-group">
                        <label>Á≠ñÁï•ÂêçÁß∞</label>
                        <input type="text" id="strategyName" placeholder="Á≠ñÁï•ÂêçÁß∞">
                    </div>
                    <div class="form-group">
                        <label>Á≠ñÁï•ÊèèËø∞</label>
                        <textarea id="strategyDescription" rows="3" placeholder="Á≠ñÁï•ÊèèËø∞"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ÂàùÂßãËµÑÈáëÔºàÂÖÉÔºâ</label>
                        <input type="number" id="initialCapital" value="100000" min="1000">
                    </div>
                    <div class="form-group">
                        <label>Á≠ñÁï•Á±ªÂûã</label>
                        <select id="strategyType">
                            <option value="MA_CROSS">MA‰∫§ÂèâÁ≠ñÁï•</option>
                            <option value="RSI">RSIÁ≠ñÁï•</option>
                            <option value="BOLLINGER">Â∏ÉÊûóÂ∏¶Á≠ñÁï•</option>
                        </select>
                    </div>
                    <div id="strategyParameters">
                        <!-- Âä®ÊÄÅÂä†ËΩΩÁ≠ñÁï•ÂèÇÊï∞ -->
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="isActive" checked> ÂêØÁî®Á≠ñÁï•</label>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="quantTrading.saveStrategy()">üíæ ‰øùÂ≠òÁ≠ñÁï•</button>
                        <button class="btn" onclick="quantTrading.testStrategy()" style="background: #ffc107; color: #000;">üß™ ÊµãËØïÁ≠ñÁï•</button>
                        <button class="btn" onclick="quantTrading.deleteStrategy()" style="background: #dc3545;">üóëÔ∏è Âà†Èô§Á≠ñÁï•</button>
                    </div>
                </div>
            </div>

            <!-- ÂõûÊµãÁªìÊûú -->
            <div class="card">
                <h3>üìà ÂõûÊµãÂàÜÊûê</h3>
                <div class="form-group">
                    <label>ÈÄâÊã©ËÇ°Á•®ËøõË°åÂõûÊµã</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="backtestStockSelect" onchange="quantTrading.onBacktestStockChange()" style="min-width: 160px;">
                            <option value="">‰ªéËá™ÈÄâËÇ°ÈÄâÊã©...</option>
                        </select>
                        <input type="text" id="backtestStock" placeholder="ËæìÂÖ•ËÇ°Á•®‰ª£Á†ÅÔºåÂ¶ÇÔºö000001" style="flex: 1;">
                        <input type="date" id="backtestStartDate" title="ÂºÄÂßãÊó•Êúü">
                        <input type="date" id="backtestEndDate" title="ÁªìÊùüÊó•Êúü">
                        <button class="btn" onclick="quantTrading.runBacktest()">üöÄ ÂºÄÂßãÂõûÊµã</button>
                    </div>
                </div>
                <div id="backtestResults" style="display: none;">
                    <div class="stats">
                        <div class="stat-card">
                            <h4>ÊÄªÊî∂ÁõäÁéá</h4>
                            <div class="value" id="totalReturn">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>Âπ¥ÂåñÊî∂ÁõäÁéá</h4>
                            <div class="value" id="annualReturn">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>ÊúÄÂ§ßÂõûÊí§</h4>
                            <div class="value" id="maxDrawdown">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>Â§èÊôÆÊØîÁéá</h4>
                            <div class="value" id="sharpeRatio">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>‰∫§ÊòìÊ¨°Êï∞</h4>
                            <div class="value" id="tradeCount">-</div>
                        </div>
                        <div class="stat-card">
                            <h4>ËÉúÁéá</h4>
                            <div class="value" id="winRate">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>‰∫§ÊòìËÆ∞ÂΩï</h4>
                        <div id="tradeHistory" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- ÂÆûÊó∂ÁõëÊéß -->
            <div class="card">
                <h3>üì° ÂÆûÊó∂ÁõëÊéß</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="quantTrading.startMonitoring()" id="startMonitorBtn">‚ñ∂Ô∏è ÂºÄÂßãÁõëÊéß</button>
                    <button class="btn" onclick="quantTrading.stopMonitoring()" id="stopMonitorBtn" style="background: #dc3545;">‚èπÔ∏è ÂÅúÊ≠¢ÁõëÊéß</button>
                    <button class="btn" onclick="quantTrading.loadActiveStrategies()">üîÑ Âà∑Êñ∞Ê¥ªË∑ÉÁ≠ñÁï•</button>
                </div>
                <div id="monitoringStatus" class="loading">ÁõëÊéßÂ∑≤ÂÅúÊ≠¢</div>
                <div id="activeStrategies"></div>
            </div>
        </div>
        
        <!-- ÈáëËûçÊñ∞Èóª -->
        <div id="news" class="content">
            <div class="card">
                <h3>ÊúÄÊñ∞ÈáëËûçÊñ∞Èóª</h3>
                <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newsSearch" placeholder="ÊêúÁ¥¢Êñ∞ÈóªÂÖ≥ÈîÆËØç" style="flex: 1;">
                    <button class="btn" onclick="searchNews()">üîç ÊêúÁ¥¢</button>
                    <button class="btn" onclick="fetchLatestNews()">üîÑ ÊäìÂèñÊúÄÊñ∞Êñ∞Èóª</button>
                    <button class="btn" onclick="analyzeBatchNews()">ü§ñ ÊâπÈáèAIÂàÜÊûê</button>
                </div>
                <div id="batchAnalysisResult" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #667eea;">
                    <h4 style="margin-top: 0; color: #667eea;">üìä Â∏ÇÂú∫ÁªºÂêàÂàÜÊûê</h4>
                    <div id="batchAnalysisContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <span id="batchAnalysisStats"></span>
                        <button onclick="hideBatchAnalysis()" style="float: right; background: none; border: none; color: #999; cursor: pointer;">‚úï ÂÖ≥Èó≠</button>
                    </div>
                </div>
                
                <!-- ÊèêÁ§∫ËØçÈÄâÊã©ÂØπËØùÊ°Ü -->
                <div id="promptSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80%; overflow-y: auto;">
                        <h3 style="margin-top: 0; color: #667eea;">ü§ñ ÈÄâÊã©AIÂàÜÊûêÊèêÁ§∫ËØç</h3>
                        <p style="color: #666; margin-bottom: 20px;">ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÊèêÁ§∫ËØçÊù•ÊåáÂØºAIÂàÜÊûêÊñ∞ÈóªÂÜÖÂÆπÔºö</p>
                        
                        <div id="promptList" style="margin-bottom: 20px;">
                            <!-- ÊèêÁ§∫ËØçÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
                        </div>
                        
                        <div style="text-align: right;">
                            <button onclick="closePromptModal()" style="margin-right: 10px; padding: 8px 16px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">ÂèñÊ∂à</button>
                            <button id="confirmPromptBtn" onclick="confirmPromptSelection()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>ÂºÄÂßãÂàÜÊûê</button>
                        </div>
                    </div>
                </div>
                
                <div id="newsList" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <!-- AIÂàÜÊûê -->
        <div id="ai" class="content">
            <div class="card">
                <h3>AIËÇ°Á•®ÂàÜÊûê</h3>
                <div class="form-group">
                    <label>ËÇ°Á•®‰ª£Á†Å</label>
                    <input type="text" id="aiStockCode" placeholder="ËæìÂÖ•Ë¶ÅÂàÜÊûêÁöÑËÇ°Á•®‰ª£Á†Å">
                </div>
                <!-- Êñ∞Â¢ûÔºöÈÄâÊã©ÊèêÁ§∫ËØç -->
                <div class="form-group">
                    <label>ÈÄâÊã©ÊèêÁ§∫ËØç</label>
                    <select id="aiPromptSelect">
                        <option value="">Ôºà‰ΩøÁî®ÈªòËÆ§ÊàñJSONÈÖçÁΩÆÔºâ</option>
                    </select>
                </div>
                <button class="btn" onclick="analyzeStock()">ÂºÄÂßãÂàÜÊûê</button>
                <div id="aiResult" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap;"></div>
            </div>
        </div>
        
        <!-- ‰ª∑Ê†ºÊèêÈÜí -->
        <div id="alert" class="content">
            <div class="card">
                <h3>ÂàõÂª∫‰ª∑Ê†ºÊèêÈÜí</h3>
                <div class="form-group">
                    <label>ËÇ°Á•®‰ª£Á†Å</label>
                    <input type="text" id="alertStockCode" placeholder="ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å">
                </div>
                <div class="form-group">
                    <label>ÁõÆÊ†á‰ª∑Ê†º</label>
                    <input type="number" step="0.01" id="alertPrice" placeholder="ËæìÂÖ•ÁõÆÊ†á‰ª∑Ê†º">
                </div>
                <div class="form-group">
                    <label>ÊèêÈÜíÁ±ªÂûã</label>
                    <select id="alertType">
                        <option value="PriceUp">‰ª∑Ê†ºÊ∂®Âà∞ÁõÆÊ†á‰ª∑</option>
                        <option value="PriceDown">‰ª∑Ê†ºË∑åÂà∞ÁõÆÊ†á‰ª∑</option>
                        <option value="PriceReach">‰ª∑Ê†ºÂà∞ËææÁõÆÊ†á‰ª∑</option>
                    </select>
                </div>
                <button class="btn" onclick="createAlert()">ÂàõÂª∫ÊèêÈÜí</button>
            </div>
            
            <div class="card">
                <h3>Ê¥ªË∑ÉÊèêÈÜí</h3>
                <div id="alertsList" class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <!-- ËÆæÁΩÆ -->
        <div id="settings" class="content">
            <!-- AIÊèêÁ§∫ËØçÈÖçÁΩÆ -->
            <div class="card">
                <h3>AIÊèêÁ§∫ËØçÈÖçÁΩÆ</h3>
                <div class="form-group">
                    <button class="btn" onclick="aiPromptManager.loadPrompts()">üîÑ Âà∑Êñ∞ÊèêÁ§∫ËØçÂàóË°®</button>
                    <button class="btn" onclick="aiPromptManager.showCreateForm()" style="margin-left: 10px;">‚ûï Ê∑ªÂä†ÊèêÁ§∫ËØç</button>
                </div>
                <div id="aiPromptList" class="loading">Âä†ËΩΩ‰∏≠...</div>

                <!-- Ê∑ªÂä†/ÁºñËæëË°®Âçï -->
                <div id="aiPromptForm" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #eee; border-radius: 5px;">
                    <h4 id="promptFormTitle">Ê∑ªÂä†Êñ∞ÊèêÁ§∫ËØç</h4>
                    <input type="hidden" id="promptId">
                    <div class="form-group">
                        <label>ÂêçÁß∞ *</label>
                        <input type="text" id="promptName" class="form-control" placeholder="‰æãÂ¶ÇÔºöÂü∫Êú¨Èù¢ÂàÜÊûê">
                    </div>
                    <div class="form-group">
                        <label>Á≥ªÁªüÊèêÁ§∫ËØç *</label>
                        <textarea id="promptText" class="form-control" rows="6" placeholder="ËæìÂÖ•Á≥ªÁªüÊèêÁ§∫ËØç"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ê∏©Â∫¶Ôºà0-2Ôºâ</label>
                        <input type="number" id="promptTemp" class="form-control" step="0.1" min="0" max="2" value="0.7">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="promptIsDefault"> ËÆæ‰∏∫ÈªòËÆ§ÊèêÁ§∫ËØç</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="promptIsActive" checked> ÂêØÁî®</label>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="aiPromptManager.savePrompt()">üíæ ‰øùÂ≠òÊèêÁ§∫ËØç</button>
                        <button class="btn btn-secondary" onclick="aiPromptManager.cancelEdit()">ÂèñÊ∂à</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ËÇ°Á•®Ë°åÊÉÖËá™Âä®Âà∑Êñ∞ËÆæÁΩÆ</h3>
                <div class="form-group">
                    <label>Âà∑Êñ∞Èó¥ÈöîÔºàÁßíÔºâ</label>
                    <input type="number" id="autoRefreshInterval" min="0.5" max="60" step="0.5" value="3">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        Êé®ËçêËÆæÁΩÆÔºö0.5-2ÁßíÔºàÂÆûÊó∂Ôºâ | 3-5ÁßíÔºàÂ∏∏ËßÑÔºâ | 10-30ÁßíÔºàÁúÅÊµÅÈáèÔºâ
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableAutoRefresh" checked>
                        ÂêØÁî®Ëá™Âä®Âà∑Êñ∞
                    </label>
                </div>
                <button class="btn" onclick="saveSettings()">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
            </div>
            
            <div class="card">
                <h3>ÈáëËûçÊ∂àÊÅØÂÆöÊó∂Âà∑Êñ∞ËÆæÁΩÆ</h3>
                <div class="form-group">
                    <label>Êñ∞ÈóªÂà∑Êñ∞Èó¥ÈöîÔºàÂàÜÈíüÔºâ</label>
                    <input type="number" id="newsRefreshInterval" min="5" max="1440" step="5" value="30">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        Êé®ËçêËÆæÁΩÆÔºö5-15ÂàÜÈíüÔºàÈ´òÈ¢ëÔºâ | 30-60ÂàÜÈíüÔºàÂ∏∏ËßÑÔºâ | 120ÂàÜÈíü‰ª•‰∏äÔºà‰ΩéÈ¢ëÔºâ
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNewsAutoRefresh" checked>
                        ÂêØÁî®Êñ∞ÈóªËá™Âä®Âà∑Êñ∞
                    </label>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="updateNewsRefreshSettings()">üíæ Êõ¥Êñ∞Êñ∞ÈóªÂà∑Êñ∞ËÆæÁΩÆ</button>
                    <button class="btn" onclick="forceRefreshNews()" style="margin-left: 10px;">üîÑ Á´ãÂç≥Âà∑Êñ∞Êñ∞Èóª</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ÂΩìÂâçÁä∂ÊÄÅ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">Âà∑Êñ∞Èó¥Èöî</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="currentInterval">3Áßí</div>
                    </div>
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">Ëá™Âä®Âà∑Êñ∞Áä∂ÊÄÅ</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="currentStatus">Â∑≤ÂêØÁî®</div>
                    </div>
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">‰∏äÊ¨°Âà∑Êñ∞</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: #666;" id="lastRefreshTime">--</div>
                    </div>
                </div>
            </div>
            
            <!-- AIÊ®°ÂûãÈÖçÁΩÆ -->
            <div class="card">
                <h3>AIÊ®°ÂûãÈÖçÁΩÆ</h3>
                <div class="form-group">
                    <button class="btn" onclick="aiConfigManager.loadConfigs()">üîÑ Âà∑Êñ∞ÈÖçÁΩÆÂàóË°®</button>
                    <button class="btn" onclick="aiConfigManager.showCreateForm()" style="margin-left: 10px;">‚ûï Ê∑ªÂä†ÈÖçÁΩÆ</button>
                </div>
                
                <!-- ÈÖçÁΩÆÂàóË°® -->
                <div id="aiConfigList" class="loading">Âä†ËΩΩ‰∏≠...</div>
                
                <!-- Ê∑ªÂä†/ÁºñËæëË°®Âçï -->
                <div id="aiConfigForm" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #eee; border-radius: 5px;">
                    <h4 id="formTitle">Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ</h4>
                    <input type="hidden" id="configId">
                    <div class="form-group">
                        <label>ÈÖçÁΩÆÂêçÁß∞ *</label>
                        <input type="text" id="configName" class="form-control" placeholder="‰æãÂ¶ÇÔºöÈÄö‰πâÂçÉÈóÆAPI">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="password" id="configApiKey" class="form-control" placeholder="ËØ∑ËæìÂÖ•APIÂØÜÈí•">
                    </div>
                    <div class="form-group">
                        <label>ËÆ¢ÈòÖÁ´ØÁÇπ *</label>
                        <input type="text" id="configSubscribeEndpoint" class="form-control" placeholder="‰æãÂ¶ÇÔºöhttps://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation">
                    </div>
                    <div class="form-group">
                        <label>Ê®°ÂûãÂêçÁß∞ *</label>
                        <input type="text" id="configModelName" class="form-control" placeholder="‰æãÂ¶ÇÔºöqwen-max">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsActive">
                            ËÆæ‰∏∫ÊøÄÊ¥ªÁä∂ÊÄÅ
                        </label>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ÊøÄÊ¥ªÁä∂ÊÄÅ‰∏ãÔºåÁ≥ªÁªüÂ∞Ü‰ΩøÁî®Ê≠§ÈÖçÁΩÆËøõË°åAIÂàÜÊûê
                        </p>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsDefault">
                            ËÆæ‰∏∫ÈªòËÆ§ÈÖçÁΩÆ
                        </label>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ÈªòËÆ§ÈÖçÁΩÆÂ∞ÜÂú®ÂàõÂª∫Êñ∞ÈÖçÁΩÆÊó∂Ëá™Âä®ÈÄâ‰∏≠
                        </p>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="aiConfigManager.saveConfig()">üíæ ‰øùÂ≠òÈÖçÁΩÆ</button>
                        <button class="btn btn-secondary" onclick="aiConfigManager.cancelEdit()">ÂèñÊ∂à</button>
                        <button class="btn btn-danger" onclick="aiConfigManager.testConnection()" style="float: right;">üß™ ÊµãËØïËøûÊé•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        
        // ÂÖ®Â±ÄÂèòÈáè
        let currentNewsData = []; // Â≠òÂÇ®ÂΩìÂâçÈ°µÈù¢ÁöÑÊñ∞ÈóªÊï∞ÊçÆ
        
        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥ÂèòÈáè
        let autoRefreshTimer = null;
        let autoRefreshInterval = 3; // ÈªòËÆ§3Áßí
        let autoRefreshEnabled = true;
        
        // TabÂàáÊç¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Ê†πÊçÆTabÂä†ËΩΩÊï∞ÊçÆ
            switch(tabName) {
                case 'watchlist':
                    loadWatchlist();
                    break;
                case 'news':
                    loadNews();
                    break;
                case 'alert':
                    loadAlerts();
                    break;
                case 'settings':
                    loadNewsRefreshSettings();
                    break;
            }
        }
        
        // Ê∑ªÂä†Ëá™ÈÄâËÇ°
        async function addToWatchlist() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const categoryId = document.getElementById('categorySelect').value;
            
            if (!stockCode || !categoryId) {
                alert('ËØ∑Â°´ÂÜôËÇ°Á•®‰ª£Á†ÅÂíåÈÄâÊã©ÂàÜÁ±ª');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stockCode, categoryId: parseInt(categoryId) })
                });
                
                if (response.ok) {
                    alert('Ê∑ªÂä†ÊàêÂäüÔºÅ');
                    document.getElementById('stockCode').value = '';
                    loadWatchlist();
                } else {
                    alert('Ê∑ªÂä†Â§±Ë¥•Ôºö' + await response.text());
                }
            } catch (error) {
                alert('Ê∑ªÂä†Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âä†ËΩΩËá™ÈÄâËÇ°
        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('Âä†ËΩΩÁöÑËá™ÈÄâËÇ°Êï∞ÊçÆÔºö', data); // Ë∞ÉËØïÁî®
                console.log('Ëá™ÈÄâËÇ°Êï∞ÊçÆËØ¶ÁªÜÔºö', JSON.stringify(data, null, 2)); // ËØ¶ÁªÜË∞ÉËØï
                
                let html = '';
                if (!data || Object.keys(data).length === 0) {
                    html = '<p style="padding: 20px; color: #999; text-align: center;">ÊöÇÊó†Ëá™ÈÄâËÇ°ÔºåËØ∑Ê∑ªÂä†ËÇ°Á•®</p>';
                } else {
                    for (const [category, stocks] of Object.entries(data)) {
                        html += `<h4 style="margin-top: 20px; color: #667eea; font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">${category}</h4>`;
                        html += '<div class="stock-cards">';
                        
                        stocks.forEach(stock => {
                            const stockData = stock.stock || {};
                            const currentPrice = stockData.currentPrice || stockData?.currentPrice || 0;
                            const changePercent = stockData.changePercent || stockData?.changePercent || 0;
                            const isPositive = changePercent >= 0;
                            const categoryColor = stock.category?.color || '#667eea';
                            
                            // È™åËØÅ‰ª∑Ê†ºÊï∞ÊçÆÊòØÂê¶ÊúâÊïà
                            const isValidPrice = currentPrice && currentPrice > 0;
                            
                            const stockName = stockData?.name || stockData?.Name || 'N/A';
                            console.log('Â§ÑÁêÜËÇ°Á•®Ôºö', stock.stockCode, 'ËÇ°Á•®ÂêçÁß∞Ôºö', stockName, 'ËÇ°Á•®Êï∞ÊçÆÔºö', stockData); // Ë∞ÉËØïÁî®
                            
                            html += `
                                <div class="stock-card" id="card-${stock.stockCode}">
                                    <div class="category-label" style="background: ${categoryColor}20; color: ${categoryColor};">
                                        ${category}
                                    </div>
                                    <div class="stock-header">
                                        <div class="stock-name-section">
                                            <div class="stock-name">${stockData.name || 'N/A'}</div>
                                            <div class="stock-code">${stock.stockCode}</div>
                                        </div>
                                        <div class="stock-actions">
                                            <button class="btn btn-small" onclick="openAI('${stock.stockCode}')">AIÂàÜÊûê</button>
                                            <button class="btn btn-danger btn-small" onclick="removeStock(${stock.id})">Âà†Èô§</button>
                                        </div>
                                    </div>
                                    <div class="price-section">
                                        <div class="current-price ${isValidPrice ? (isPositive ? 'price-up' : 'price-down') : ''}">
                                            ${isValidPrice ? currentPrice.toFixed(2) : 'ÊöÇÊó†Êï∞ÊçÆ'}
                                        </div>
                                        ${isValidPrice ? `
                                        <div class="price-info-row">
                                            <div>
                                                <span class="${isPositive ? 'price-up' : 'price-down'}">
                                                    ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">ÊúÄÈ´ò</span>
                                                <span class="price-value">${stockData.highPrice ? stockData.highPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">ÊúÄ‰Ωé</span>
                                                <span class="price-value">${stockData.lowPrice ? stockData.lowPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="price-info-row">
                                            <div class="price-item">
                                                <span class="price-label">‰ªäÂºÄ</span>
                                                <span class="price-value">${stockData.openPrice ? stockData.openPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">Êò®Êî∂</span>
                                                <span class="price-value">${stockData.closePrice ? stockData.closePrice.toFixed(2) : (stockData.prevClose ? stockData.prevClose.toFixed(2) : 'N/A')}</span>
                                            </div>
                                        </div>
                                        ` : `
                                        <div class="price-info-row">
                                            <div class="no-data">ÊöÇÊó†ÊúâÊïà‰ª∑Ê†ºÊï∞ÊçÆ</div>
                                        </div>
                                        `}
                                    </div>
                                    <div class="market-info">
                                        <div style="color: #666;">
                                            Êàê‰∫§Èáè: ${stockData.volume ? (stockData.volume / 10000).toFixed(2) + '‰∏á' : 'N/A'}
                                        </div>
                                        <div class="cost-info ${stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative'}">
                                            ÊàêÊú¨: ${stock.costPrice ? stock.costPrice.toFixed(2) : '-'} √ó ${stock.quantity || '-'}<br>
                                            Áõà‰∫è: <strong>${stock.profitLoss !== undefined ? stock.profitLoss.toFixed(2) : '-'}</strong>
                                            (${stock.profitLossPercent !== undefined ? stock.profitLossPercent.toFixed(2) : '-'}%)
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                }
                
                document.getElementById('watchlistList').innerHTML = html;
                
                // Êñ∞Â¢ûÔºöÂ°´ÂÖÖÂõûÊµã‰∏ãÊãâÊ°Ü
                try {
                    const codes = Object.values(data || {})
                        .flatMap(arr => (Array.isArray(arr) ? arr : []))
                        .map(s => s.stockCode)
                        .filter(Boolean);

                    const uniqueCodes = Array.from(new Set(codes));
                    const sel = document.getElementById('backtestStockSelect');
                    if (sel) {
                        sel.innerHTML = '<option value="">‰ªéËá™ÈÄâËÇ°ÈÄâÊã©...</option>' + 
                            uniqueCodes.map(c => `<option value="${c}">${c}</option>`).join('');
                    }
                } catch (e) {
                    console.warn('Â°´ÂÖÖÂõûÊµãËÇ°Á•®‰∏ãÊãâÂ§±Ë¥•:', e);
                }
            } catch (error) {
                document.getElementById('watchlistList').innerHTML = '<p>Âä†ËΩΩÂ§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        // Êù°‰ª∂ÈÄâËÇ°
        async function screenStocks() {
            const criteria = {
                market: document.getElementById('market').value || null,
                minPrice: parseFloat(document.getElementById('minPrice').value) || null,
                maxPrice: parseFloat(document.getElementById('maxPrice').value) || null,
                minChangePercent: parseFloat(document.getElementById('minChange').value) || null,
                maxChangePercent: parseFloat(document.getElementById('maxChange').value) || null,
                minTurnoverRate: parseFloat(document.getElementById('minTurnover').value) || null,
                maxTurnoverRate: parseFloat(document.getElementById('maxTurnover').value) || null,
                minPE: parseFloat(document.getElementById('minPE').value) || null,
                maxPE: parseFloat(document.getElementById('maxPE').value) || null,
                minPB: parseFloat(document.getElementById('minPB').value) || null,
                maxPB: parseFloat(document.getElementById('maxPB').value) || null,
                minVolume: parseFloat(document.getElementById('minVolume').value) || null,
                maxVolume: parseFloat(document.getElementById('maxVolume').value) || null,
                minMarketValue: parseFloat(document.getElementById('minMarketValue').value) || null,
                maxMarketValue: parseFloat(document.getElementById('maxMarketValue').value) || null,
                minDividendYield: parseFloat(document.getElementById('minDividendYield').value) || null,
                maxDividendYield: parseFloat(document.getElementById('maxDividendYield').value) || null
            };
            
            try {
                document.getElementById('screenResults').innerHTML = '<div class="loading">Êü•ËØ¢‰∏≠...</div>';
                const response = await fetch(`${API_BASE}/api/screen/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(criteria)
                });
                
                const stocks = await response.json();
                
                let html = `<p>ÊâæÂà∞ ${stocks.length} Âè™ËÇ°Á•®</p><table><thead><tr><th>‰ª£Á†Å</th><th>ÂêçÁß∞</th><th>ÂΩìÂâç‰ª∑</th><th>Ê∂®Ë∑åÂπÖ</th><th>Êç¢ÊâãÁéá</th><th>PE</th><th>PB</th><th>Êàê‰∫§Èáè</th></tr></thead><tbody>`;
                
                stocks.forEach(stock => {
                    html += `
                        <tr>
                            <td>${stock.code}</td>
                            <td>${stock.name}</td>
                            <td>${stock.currentPrice.toFixed(2)}</td>
                            <td class="${stock.changePercent >= 0 ? 'price-up' : 'price-down'}">
                                ${stock.changePercent.toFixed(2)}%
                            </td>
                            <td>${stock.turnoverRate.toFixed(2)}%</td>
                            <td>${stock.pe?.toFixed(2) || '-'}</td>
                            <td>${stock.pb?.toFixed(2) || '-'}</td>
                            <td>${(stock.volume / 10000).toFixed(2)}‰∏áÊâã</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('screenResults').innerHTML = html;
            } catch (error) {
                document.getElementById('screenResults').innerHTML = '<p>Êü•ËØ¢Â§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        // Âä†ËΩΩÊñ∞Èóª
        async function loadNews() {
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
                const response = await fetch(`${API_BASE}/api/news/latest?count=50`);
                const news = await response.json();
                
                if (news && news.length > 0) {
                    currentNewsData = news; // Â≠òÂÇ®Êñ∞ÈóªÊï∞ÊçÆ
                    displayNews(news);
                } else {
                    currentNewsData = []; // Ê∏ÖÁ©∫Êï∞ÊçÆ
                    // Â¶ÇÊûúÊ≤°ÊúâÊñ∞ÈóªÊï∞ÊçÆÔºåÂ∞ùËØïËá™Âä®ÊäìÂèñ
                    await fetchLatestNews();
                }
            } catch (error) {
                currentNewsData = []; // Ê∏ÖÁ©∫Êï∞ÊçÆ
                document.getElementById('newsList').innerHTML = '<p>Âä†ËΩΩÂ§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        // ÊòæÁ§∫Êñ∞ÈóªÂàóË°®
        function displayNews(news) {
            let html = '';
            if (news && news.length > 0) {
                news.forEach(item => {
                    const stockCodes = item.stockCodes ? item.stockCodes.join(', ') : '';
                    const content = item.content || item.title;
                    html += `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openNewsDetail('${item.id}')">
                            <strong style="color: #667eea; font-size: 1.1em;">${item.title}</strong>
                            <p style="color: #666; margin-top: 8px; font-size: 0.9em; line-height: 1.4;">${content.substring(0, 120)}${content.length > 120 ? '...' : ''}</p>
                            <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #999; font-size: 0.8em;">
                                    üì∞ ${item.source} ¬∑ ${new Date(item.publishTime).toLocaleString()}
                                    ${stockCodes ? ' ¬∑ üìà ' + stockCodes : ''}
                                </span>
                                <div>
                                    <span style="color: #999; font-size: 0.8em;">üëÅÔ∏è ${item.viewCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p style="padding: 20px; text-align: center; color: #999;">ÊöÇÊó†Êñ∞ÈóªÊï∞ÊçÆÔºåËØ∑ÁÇπÂáª"ÊäìÂèñÊúÄÊñ∞Êñ∞Èóª"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ÈáëËûçÊ∂àÊÅØ</p>';
            }
            
            document.getElementById('newsList').innerHTML = html;
        }
        
        // ÊêúÁ¥¢Êñ∞Èóª
        async function searchNews() {
            const keyword = document.getElementById('newsSearch').value.trim();
            if (!keyword) {
                alert('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç');
                return;
            }
            
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">ÊêúÁ¥¢‰∏≠...</div>';
                const response = await fetch(`${API_BASE}/api/news/search?keyword=${encodeURIComponent(keyword)}`);
                const news = await response.json();
                
                currentNewsData = news || []; // Êõ¥Êñ∞ÂΩìÂâçÊñ∞ÈóªÊï∞ÊçÆ
                displayNews(news);
            } catch (error) {
                currentNewsData = []; // Ê∏ÖÁ©∫Êï∞ÊçÆ
                document.getElementById('newsList').innerHTML = '<p>ÊêúÁ¥¢Â§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        // ÊäìÂèñÊúÄÊñ∞Êñ∞Èóª
        async function fetchLatestNews() {
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">Ê≠£Âú®‰ªéÂ§©Ë°åÊï∞ÊçÆÂíåÊñ∞Êµ™Ë¥¢ÁªèÊäìÂèñÊúÄÊñ∞Êñ∞Èóª...</div>';
                
                const response = await fetch(`${API_BASE}/api/news/fetch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Êñ∞ÈóªÊäìÂèñ‰ªªÂä°Â∑≤ÂêØÂä®ÔºåËØ∑Á®çÂêéÂà∑Êñ∞Êü•Áúã');
                    
                    // Á≠âÂæÖ2ÁßíÂêéÂà∑Êñ∞Êñ∞ÈóªÂàóË°®
                    setTimeout(() => {
                        loadNews();
                    }, 2000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                document.getElementById('newsList').innerHTML = '<p>ÊäìÂèñÂ§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }

        // ÊâπÈáèAIÂàÜÊûêÊñ∞Èóª - ÊòæÁ§∫ÊèêÁ§∫ËØçÈÄâÊã©ÂØπËØùÊ°Ü
        async function analyzeBatchNews() {
            try {
                // È¶ñÂÖàÂä†ËΩΩÊèêÁ§∫ËØçÂàóË°®
                await loadPrompts();
                
                // ÊòæÁ§∫ÊèêÁ§∫ËØçÈÄâÊã©ÂØπËØùÊ°Ü
                document.getElementById('promptSelectionModal').style.display = 'block';
                
            } catch (error) {
                alert('Âä†ËΩΩÊèêÁ§∫ËØçÂ§±Ë¥•Ôºö' + error.message);
            }
        }

        // Âä†ËΩΩÊèêÁ§∫ËØçÂàóË°®
        async function loadPrompts() {
            try {
                const response = await fetch(`${API_BASE}/api/news/prompts`);
                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÊèêÁ§∫ËØçÂàóË°®Â§±Ë¥•');
                }
                
                const prompts = await response.json();
                const promptList = document.getElementById('promptList');
                
                let html = '';
                
                // Ê∑ªÂä†ÈªòËÆ§ÈÄâÈ°π
                html += `
                    <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;" onclick="selectPrompt(null, 'ÈªòËÆ§ÂàÜÊûê', '‰ΩøÁî®Á≥ªÁªüÈªòËÆ§ÁöÑÈáëËûçÊñ∞ÈóªÂàÜÊûêÊèêÁ§∫ËØç')">
                        <input type="radio" name="promptSelection" value="" style="margin-right: 8px;">
                        <strong>ÈªòËÆ§ÂàÜÊûê</strong>
                        <p style="margin: 5px 0 0 20px; color: #666; font-size: 0.9em;">‰ΩøÁî®Á≥ªÁªüÈªòËÆ§ÁöÑÈáëËûçÊñ∞ÈóªÂàÜÊûêÊèêÁ§∫ËØç</p>
                    </div>
                `;
                
                // Ê∑ªÂä†Ëá™ÂÆö‰πâÊèêÁ§∫ËØç
                prompts.forEach(prompt => {
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;" onclick="selectPrompt(${prompt.id}, '${prompt.name}', '${prompt.description}')">
                            <input type="radio" name="promptSelection" value="${prompt.id}" style="margin-right: 8px;">
                            <strong>${prompt.name}</strong>
                            <p style="margin: 5px 0 0 20px; color: #666; font-size: 0.9em;">${prompt.description}</p>
                        </div>
                    `;
                });
                
                promptList.innerHTML = html;
                
            } catch (error) {
                throw error;
            }
        }

        // ÈÄâÊã©ÊèêÁ§∫ËØç
        let selectedPromptId = null;
        function selectPrompt(promptId, promptName, promptDescription) {
            selectedPromptId = promptId;
            
            // Êõ¥Êñ∞ÂçïÈÄâÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('input[name="promptSelection"]').forEach(radio => {
                radio.checked = (radio.value == (promptId || ''));
            });
            
            // ÂêØÁî®Á°ÆËÆ§ÊåâÈíÆ
            document.getElementById('confirmPromptBtn').disabled = false;
        }

        // ÂÖ≥Èó≠ÊèêÁ§∫ËØçÈÄâÊã©ÂØπËØùÊ°Ü
        function closePromptModal() {
            document.getElementById('promptSelectionModal').style.display = 'none';
            selectedPromptId = null;
            document.getElementById('confirmPromptBtn').disabled = true;
        }

        // Á°ÆËÆ§ÊèêÁ§∫ËØçÈÄâÊã©Âπ∂ÂºÄÂßãÂàÜÊûê
        async function confirmPromptSelection() {
            try {
                // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
                closePromptModal();
                
                // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÁöÑÊâÄÊúâÊñ∞ÈóªID
                const newsIds = currentNewsData.map(news => news.id);
                
                if (newsIds.length === 0) {
                    alert('ÂΩìÂâçÈ°µÈù¢Ê≤°ÊúâÊñ∞ÈóªÊï∞ÊçÆÔºåËØ∑ÂÖàÂä†ËΩΩÊñ∞Èóª');
                    return;
                }

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const resultDiv = document.getElementById('batchAnalysisResult');
                const contentDiv = document.getElementById('batchAnalysisContent');
                const statsDiv = document.getElementById('batchAnalysisStats');
                
                resultDiv.style.display = 'block';
                contentDiv.innerHTML = 'ü§ñ Ê≠£Âú®ËøõË°åÂ∏ÇÂú∫ÁªºÂêàÂàÜÊûêÔºåËØ∑Á®çÂÄô...';
                statsDiv.innerHTML = '';

                // Ë∞ÉÁî®ÊâπÈáèÂàÜÊûêAPI
                const requestBody = {
                    newsIds: newsIds
                };
                
                if (selectedPromptId) {
                    requestBody.promptId = selectedPromptId;
                }

                const response = await fetch(`${API_BASE}/api/news/analyze-batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('ÊâπÈáèÂàÜÊûêËØ∑Ê±ÇÂ§±Ë¥•');
                }

                const result = await response.json();
                
                // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
                contentDiv.innerHTML = result.analysis || result;
                
                // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
                if (result.newsCount !== undefined) {
                    const timeRange = result.timeRange;
                    const hotStocks = result.hotStocks || [];
                    
                    let statsHtml = `üìä ÂàÜÊûê‰∫Ü ${result.newsCount} Êù°Êñ∞Èóª`;
                    if (timeRange) {
                        const fromTime = new Date(timeRange.from).toLocaleString();
                        const toTime = new Date(timeRange.to).toLocaleString();
                        statsHtml += ` | ‚è∞ Êó∂Èó¥ËåÉÂõ¥: ${fromTime} ~ ${toTime}`;
                    }
                    if (hotStocks.length > 0) {
                        statsHtml += ` | üî• ÁÉ≠Èó®ËÇ°Á•®: ${hotStocks.slice(0, 5).join(', ')}`;
                    }
                    
                    statsDiv.innerHTML = statsHtml;
                }

            } catch (error) {
                const contentDiv = document.getElementById('batchAnalysisContent');
                contentDiv.innerHTML = `‚ùå ÊâπÈáèÂàÜÊûêÂ§±Ë¥•Ôºö${error.message}`;
            }
        }

        // ÈöêËóèÊâπÈáèÂàÜÊûêÁªìÊûú
        function hideBatchAnalysis() {
            document.getElementById('batchAnalysisResult').style.display = 'none';
        }
        
        // ÊâìÂºÄÊñ∞ÈóªËØ¶ÊÉÖÔºàÂç†‰ΩçÂáΩÊï∞ÔºåÂèØÊ†πÊçÆÈúÄË¶ÅÊâ©Â±ïÔºâ
        function openNewsDetail(newsId) {
            alert('Êñ∞ÈóªËØ¶ÊÉÖÂäüËÉΩÂæÖÂºÄÂèëÔºåÊñ∞ÈóªID: ' + newsId);
            // ËøôÈáåÂèØ‰ª•Êâ©Â±ï‰∏∫ÊâìÂºÄÊ®°ÊÄÅÊ°ÜÊòæÁ§∫ÂÆåÊï¥Êñ∞ÈóªÂÜÖÂÆπ
        }
        
        // Êõ¥Êñ∞Êñ∞ÈóªÂà∑Êñ∞ËÆæÁΩÆ
        async function updateNewsRefreshSettings() {
            const intervalMinutes = document.getElementById('newsRefreshInterval').value;
            const enabled = document.getElementById('enableNewsAutoRefresh').checked;
            
            try {
                const response = await fetch(`${API_BASE}/api/news/refresh-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        intervalMinutes: parseInt(intervalMinutes),
                        enabled: enabled
                    })
                });
                
                if (response.ok) {
                    alert('Êñ∞ÈóªÂà∑Êñ∞ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞ÔºÅ');
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                alert('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âº∫Âà∂Á´ãÂç≥Âà∑Êñ∞Êñ∞Èóª
        async function forceRefreshNews() {
            try {
                const response = await fetch(`${API_BASE}/api/news/fetch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Êñ∞ÈóªÂà∑Êñ∞‰ªªÂä°Â∑≤ÂêØÂä®ÔºåËØ∑Á®çÂêéÊü•ÁúãÊñ∞ÈóªÈ°µÈù¢');
                    
                    // Á≠âÂæÖ3ÁßíÂêéÂà∑Êñ∞Êñ∞ÈóªÂàóË°®
                    setTimeout(() => {
                        if (document.getElementById('news').classList.contains('active')) {
                            loadNews();
                        }
                    }, 3000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                alert('Âà∑Êñ∞Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âä†ËΩΩÊñ∞ÈóªÂà∑Êñ∞ËÆæÁΩÆ
        async function loadNewsRefreshSettings() {
            try {
                const response = await fetch(`${API_BASE}/api/news/refresh-settings`);
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('newsRefreshInterval').value = settings.intervalMinutes || 30;
                    document.getElementById('enableNewsAutoRefresh').checked = settings.enabled !== false;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊñ∞ÈóªÂà∑Êñ∞ËÆæÁΩÆÂ§±Ë¥•Ôºö', error);
            }
        }
        
        // AIÂàÜÊûê
        async function analyzeStock() {
            const stockCode = document.getElementById('aiStockCode').value.trim();
            const promptIdVal = document.getElementById('aiPromptSelect').value;
            const promptId = promptIdVal ? parseInt(promptIdVal) : null;

            if (!stockCode) {
                alert('ËØ∑ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å');
                return;
            }

            try {
                document.getElementById('aiResult').textContent = 'ÂàÜÊûê‰∏≠...';
                const response = await fetch(`${API_BASE}/api/ai/analyze/${stockCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promptId, context: "" })
                });
                const result = await response.text();
                document.getElementById('aiResult').textContent = result;
            } catch (error) {
                document.getElementById('aiResult').textContent = 'ÂàÜÊûêÂ§±Ë¥•Ôºö' + error.message;
            }
        }
        
        // ÂàõÂª∫ÊèêÈÜí
        async function createAlert() {
            const stockCode = document.getElementById('alertStockCode').value.trim();
            const targetPrice = parseFloat(document.getElementById('alertPrice').value);
            const type = document.getElementById('alertType').value;
            
            if (!stockCode || !targetPrice) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/alert/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stockCode, targetPrice, type })
                });
                
                if (response.ok) {
                    alert('ÂàõÂª∫ÊàêÂäüÔºÅ');
                    document.getElementById('alertStockCode').value = '';
                    document.getElementById('alertPrice').value = '';
                    loadAlerts();
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•Ôºö' + await response.text());
                }
            } catch (error) {
                alert('ÂàõÂª∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âä†ËΩΩÊèêÈÜí
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/alert/active`);
                const alerts = await response.json();
                
                let html = '<table><thead><tr><th>ËÇ°Á•®‰ª£Á†Å</th><th>ÁõÆÊ†á‰ª∑</th><th>Á±ªÂûã</th><th>Áä∂ÊÄÅ</th><th>ÂàõÂª∫Êó∂Èó¥</th><th>Êìç‰Ωú</th></tr></thead><tbody>';
                
                alerts.forEach(alert => {
                    html += `
                        <tr>
                            <td>${alert.stockCode}</td>
                            <td>${alert.targetPrice.toFixed(2)}</td>
                            <td>${getAlertTypeName(alert.type)}</td>
                            <td>${alert.isTriggered ? 'Â∑≤Ëß¶Âèë' : 'ÂæÖËß¶Âèë'}</td>
                            <td>${new Date(alert.createTime).toLocaleString()}</td>
                            <td><button class="btn btn-danger" onclick="deleteAlert(${alert.id})">Âà†Èô§</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('alertsList').innerHTML = html || '<p>ÊöÇÊó†ÊèêÈÜí</p>';
            } catch (error) {
                document.getElementById('alertsList').innerHTML = '<p>Âä†ËΩΩÂ§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        function getAlertTypeName(type) {
            const types = {
                'PriceUp': '‰ª∑Ê†º‰∏äÊ∂®',
                'PriceDown': '‰ª∑Ê†º‰∏ãË∑å',
                'PriceReach': 'Âà∞Ëææ‰ª∑Ê†º'
            };
            return types[type] || type;
        }
        
        function removeStock(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü')) {
                fetch(`${API_BASE}/api/watchlist/${id}`, { method: 'DELETE' })
                    .then(() => loadWatchlist());
            }
        }
        
        function deleteAlert(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü')) {
                fetch(`${API_BASE}/api/alert/${id}`, { method: 'DELETE' })
                    .then(() => loadAlerts());
            }
        }
        
        // Âà∑Êñ∞Ëá™ÈÄâËÇ°
        async function refreshWatchlist() {
            const watchlistList = document.getElementById('watchlistList');
            watchlistList.innerHTML = '<div class="loading">Âà∑Êñ∞‰∏≠...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('Âà∑Êñ∞ÂêéÁöÑËá™ÈÄâËÇ°Êï∞ÊçÆÔºö', data);
                
                let html = '';
                if (!data || Object.keys(data).length === 0) {
                    html = '<p style="padding: 20px; color: #999; text-align: center;">ÊöÇÊó†Ëá™ÈÄâËÇ°ÔºåËØ∑Ê∑ªÂä†ËÇ°Á•®</p>';
                } else {
                    for (const [category, stocks] of Object.entries(data)) {
                        html += `<h4 style="margin-top: 20px; color: #667eea; font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">${category}</h4>`;
                        html += '<div class="stock-cards">';
                        
                        // ÊâπÈáèÂà∑Êñ∞ËÇ°Á•®Ë°åÊÉÖ
                        for (const stock of stocks) {
                            try {
                                await fetch(`${API_BASE}/api/stock/${stock.stockCode}`);
                            } catch (e) {
                                console.error('Âà∑Êñ∞ËÇ°Á•®Ë°åÊÉÖÂ§±Ë¥•Ôºö', stock.stockCode, e);
                            }
                        }
                        
                        // ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
                        const updatedResponse = await fetch(`${API_BASE}/api/watchlist/grouped`);
                        const updatedData = await updatedResponse.json();
                        const categoryStocks = updatedData[category] || stocks;
                        
                        categoryStocks.forEach(stock => {
                            const profitClass = (stock.profitLoss || 0) >= 0 ? 'price-up' : 'price-down';
                            const stockData = stock.stock || {};
                            const currentPrice = stockData.currentPrice || 0;
                            const changePercent = stockData.changePercent || 0;
                            const isPositive = changePercent >= 0;
                            const categoryColor = stock.category?.color || '#667eea';
                            
                            html += `
                                <div class="stock-card">
                                    <div class="category-label" style="background: ${categoryColor}20; color: ${categoryColor};">
                                        ${category}
                                    </div>
                                    <div class="stock-header">
                                        <div class="stock-name-section">
                                            <div class="stock-name">${stockData.name || 'N/A'}</div>
                                            <div class="stock-code">${stock.stockCode}</div>
                                        </div>
                                        <div class="stock-actions">
                                            <button class="btn btn-small" onclick="openAI('${stock.stockCode}')">AIÂàÜÊûê</button>
                                            <button class="btn btn-danger btn-small" onclick="removeStock(${stock.id})">Âà†Èô§</button>
                                        </div>
                                    </div>
                                    <div class="price-section">
                                        <div class="current-price ${isPositive ? 'price-up' : 'price-down'}">
                                            ${currentPrice.toFixed(2)}
                                        </div>
                                        <div class="price-info-row">
                                            <div>
                                                <span class="${isPositive ? 'price-up' : 'price-down'}">
                                                    ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">ÊúÄÈ´ò</span>
                                                <span class="price-value">${stockData.highPrice ? stockData.highPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">ÊúÄ‰Ωé</span>
                                                <span class="price-value">${stockData.lowPrice ? stockData.lowPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="price-info-row">
                                            <div class="price-item">
                                                <span class="price-label">Êò®Êî∂</span>
                                                <span class="price-value">${stockData.closePrice ? stockData.closePrice.toFixed(2) : (stockData.prevClose ? stockData.prevClose.toFixed(2) : 'N/A')}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">‰ªäÂºÄ</span>
                                                <span class="price-value">${stockData.openPrice ? stockData.openPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="market-info">
                                        <div style="color: #666;">
                                            Êàê‰∫§Èáè: ${stockData.volume ? (stockData.volume / 10000).toFixed(2) + '‰∏á' : 'N/A'}
                                        </div>
                                        <div class="cost-info ${stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative'}">
                                            ÊàêÊú¨: ${stock.costPrice ? stock.costPrice.toFixed(2) : '-'} √ó ${stock.quantity || '-'}<br>
                                            Áõà‰∫è: <strong>${stock.profitLoss !== undefined ? stock.profitLoss.toFixed(2) : '-'}</strong>
                                            (${stock.profitLossPercent !== undefined ? stock.profitLossPercent.toFixed(2) : '-'}%)
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                }
                
                watchlistList.innerHTML = html;
                updateLastRefreshTime(); // Êõ¥Êñ∞Âà∑Êñ∞Êó∂Èó¥
            } catch (error) {
                watchlistList.innerHTML = '<p>Âà∑Êñ∞Â§±Ë¥•Ôºö' + error.message + '</p>';
            }
        }
        
        // ÊâìÂºÄAIÂàÜÊûê
        function openAI(stockCode) {
            // ÂàáÊç¢Âà∞AIÂàÜÊûêÊ†áÁ≠æ
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab:nth-child(4)').classList.add('active');
            document.getElementById('ai').classList.add('active');
            
            // ËÆæÁΩÆËÇ°Á•®‰ª£Á†Å
            document.getElementById('aiStockCode').value = stockCode;
            
            // Âà∑Êñ∞ÊèêÁ§∫ËØçÂàóË°®ÔºàÈò≤Ê≠¢Êú™ÂàùÂßãÂåñÔºâ
            aiPromptManager.fillPromptSelect();
            
            // Ëá™Âä®ÂàÜÊûê
            analyzeStock();
        }
        
        // ÊòæÁ§∫ÂàõÂª∫ÂàÜÁ±ªÂØπËØùÊ°Ü
        function showCreateCategory() {
            document.getElementById('createCategoryModal').style.display = 'flex';
        }
        
        // ÈöêËóèÂàõÂª∫ÂàÜÁ±ªÂØπËØùÊ°Ü
        function hideCreateCategory() {
            document.getElementById('createCategoryModal').style.display = 'none';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryDesc').value = '';
            document.getElementById('categoryColor').value = '#1890ff';
        }
        
        // ÂàõÂª∫ÂàÜÁ±ª
        async function createCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const desc = document.getElementById('categoryDesc').value.trim();
            const color = document.getElementById('categoryColor').value;
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc, color })
                });
                
                if (response.ok) {
                    alert('ÂàÜÁ±ªÂàõÂª∫ÊàêÂäüÔºÅ');
                    hideCreateCategory();
                    loadCategories(); // ÈáçÊñ∞Âä†ËΩΩÂàÜÁ±ªÂàóË°®
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•Ôºö' + await response.text());
                }
            } catch (error) {
                alert('ÂàõÂª∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // Âä†ËΩΩÂàÜÁ±ª
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/categories`);
                const categories = await response.json();
                
                let html = '<option value="">ËØ∑ÈÄâÊã©ÂàÜÁ±ª</option>';
                if (categories.length === 0) {
                    html += '<option value="" disabled>ÊöÇÊó†ÂàÜÁ±ªÔºåËØ∑ÂÖàÂàõÂª∫ÂàÜÁ±ª</option>';
                } else {
                    categories.forEach(cat => {
                        html += `<option value="${cat.id}" style="background: ${cat.color}20;">${cat.name}</option>`;
                    });
                }
                
                document.getElementById('categorySelect').innerHTML = html;
            } catch (error) {
                console.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•Ôºö', error);
                document.getElementById('categorySelect').innerHTML = '<option value="">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</option>';
            }
        }
        
        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥ÂáΩÊï∞
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            if (autoRefreshEnabled) {
                autoRefreshTimer = setInterval(() => {
                    if (document.getElementById('watchlist').classList.contains('active')) {
                        refreshStockCards(); // Âè™Âà∑Êñ∞Âç°ÁâáÊï∞ÊçÆÔºå‰∏çÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™ÂàóË°®
                    }
                }, autoRefreshInterval * 1000);
            }
        }
        
        // Âè™Âà∑Êñ∞ËÇ°Á•®Âç°ÁâáÊï∞ÊçÆÔºå‰∏çÈáçÊñ∞Âä†ËΩΩÊï¥‰∏™È°µÈù¢
        async function refreshStockCards() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                for (const [category, stocks] of Object.entries(data)) {
                    for (const stock of stocks) {
                        const stockData = stock.stock || {};
                        const cardId = `card-${stock.stockCode}`;
                        const card = document.getElementById(cardId);
                        
                        if (card) {
                            // Êõ¥Êñ∞‰ª∑Ê†º
                            const currentPriceEl = card.querySelector('.current-price');
                            if (currentPriceEl) {
                                const price = stockData.currentPrice || 0;
                                const changePercent = stockData.changePercent || 0;
                                const isPositive = changePercent >= 0;
                                currentPriceEl.textContent = price.toFixed(2);
                                currentPriceEl.className = `current-price ${isPositive ? 'price-up' : 'price-down'}`;
                            }
                            
                            // Êõ¥Êñ∞Ê∂®Ë∑åÂπÖ
                            const changePercentEl = card.querySelector('.price-info-row > div > span');
                            if (changePercentEl && stockData.changePercent !== undefined) {
                                const changePercent = stockData.changePercent || 0;
                                changePercentEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                                changePercentEl.className = changePercent >= 0 ? 'price-up' : 'price-down';
                            }
                            
                            // Êõ¥Êñ∞ÂÖ∂‰ªñ‰ª∑Ê†º‰ø°ÊÅØ
                            const priceItems = card.querySelectorAll('.price-item .price-value');
                            if (priceItems.length >= 4) {
                                // Êõ¥Êñ∞ÊúÄÈ´ò‰ª∑
                                if (stockData.highPrice !== undefined) {
                                    priceItems[0].textContent = stockData.highPrice.toFixed(2);
                                }
                                // Êõ¥Êñ∞ÊúÄ‰Ωé‰ª∑
                                if (stockData.lowPrice !== undefined) {
                                    priceItems[1].textContent = stockData.lowPrice.toFixed(2);
                                }
                                // Êõ¥Êñ∞‰ªäÂºÄ‰ª∑
                                if (stockData.openPrice !== undefined) {
                                    priceItems[2].textContent = stockData.openPrice.toFixed(2);
                                }
                                // Êõ¥Êñ∞Êò®Êî∂‰ª∑
                                const closePrice = stockData.closePrice !== undefined ? stockData.closePrice : stockData.prevClose;
                                if (closePrice !== undefined) {
                                    priceItems[3].textContent = closePrice.toFixed(2);
                                }
                            }
                            
                            // Êõ¥Êñ∞Áõà‰∫è
                            if (stock.profitLoss !== undefined) {
                                const costInfoEl = card.querySelector('.cost-info');
                                if (costInfoEl) {
                                    const profitClass = stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative';
                                    costInfoEl.className = `cost-info ${profitClass}`;
                                    
                                    const profitStrong = costInfoEl.querySelector('strong');
                                    if (profitStrong) {
                                        profitStrong.textContent = stock.profitLoss.toFixed(2);
                                    }
                                    
                                    const profitPercent = costInfoEl.textContent.match(/\(([^)]+)\)$/);
                                    if (stock.profitLossPercent !== undefined && profitStrong) {
                                        const parent = profitStrong.parentElement;
                                        if (parent) {
                                            parent.textContent = parent.textContent.replace(/\([^)]+\)/, `(${stock.profitLossPercent.toFixed(2)}%)`);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                updateLastRefreshTime();
            } catch (error) {
                console.error('Âà∑Êñ∞ËÇ°Á•®Âç°ÁâáÂ§±Ë¥•Ôºö', error);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('toggleRefreshBtn');
            const status = document.getElementById('refreshStatus');
            
            if (autoRefreshEnabled) {
                btn.innerHTML = '‚è∏Ô∏è ÊöÇÂÅú';
                status.textContent = 'Â∑≤ÂêØÁî®';
                status.style.color = '#4caf50';
                startAutoRefresh();
            } else {
                btn.innerHTML = '‚ñ∂Ô∏è ÁªßÁª≠';
                status.textContent = 'Â∑≤ÊöÇÂÅú';
                status.style.color = '#f44336';
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                }
            }
        }
        
        function saveSettings() {
            autoRefreshInterval = parseFloat(document.getElementById('autoRefreshInterval').value);
            autoRefreshEnabled = document.getElementById('enableAutoRefresh').checked;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('refreshInterval').textContent = autoRefreshInterval;
            document.getElementById('currentInterval').textContent = autoRefreshInterval + 'Áßí';
            document.getElementById('currentStatus').textContent = autoRefreshEnabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®';
            document.getElementById('currentStatus').style.color = autoRefreshEnabled ? '#4caf50' : '#f44336';
            
            // ÈáçÂêØËá™Âä®Âà∑Êñ∞
            startAutoRefresh();
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('autoRefreshInterval', autoRefreshInterval);
            localStorage.setItem('autoRefreshEnabled', autoRefreshEnabled);
            
            alert('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
        }
        
        // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
        function loadSettings() {
            const savedInterval = localStorage.getItem('autoRefreshInterval');
            const savedEnabled = localStorage.getItem('autoRefreshEnabled');
            
            if (savedInterval) {
                autoRefreshInterval = parseFloat(savedInterval);
                document.getElementById('autoRefreshInterval').value = autoRefreshInterval;
                document.getElementById('refreshInterval').textContent = autoRefreshInterval;
                document.getElementById('currentInterval').textContent = autoRefreshInterval + 'Áßí';
            }
            
            if (savedEnabled !== null) {
                autoRefreshEnabled = savedEnabled === 'true';
                document.getElementById('enableAutoRefresh').checked = autoRefreshEnabled;
                if (!autoRefreshEnabled) {
                    document.getElementById('toggleRefreshBtn').innerHTML = '‚ñ∂Ô∏è ÁªßÁª≠';
                    document.getElementById('refreshStatus').textContent = 'Â∑≤ÊöÇÂÅú';
                    document.getElementById('refreshStatus').style.color = '#f44336';
                    document.getElementById('currentStatus').textContent = 'Â∑≤Á¶ÅÁî®';
                    document.getElementById('currentStatus').style.color = '#f44336';
                }
            }
        }
        
        // Êõ¥Êñ∞ÊúÄÂêéÂà∑Êñ∞Êó∂Èó¥
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('lastRefreshTime').textContent = timeStr;
        }
        
        // AIÊ®°ÂûãÈÖçÁΩÆÁÆ°ÁêÜ
        class AIConfigManager {
            constructor() {
                this.configs = [];
                this.apiBase = window.location.origin;
            }

            // ÂàùÂßãÂåñ
            async init() {
                await this.loadConfigs();
                this.renderConfigList();
            }

            // Âä†ËΩΩÊâÄÊúâÈÖçÁΩÆ
            async loadConfigs() {
                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig`);
                    if (response.ok) {
                        this.configs = await response.json();
                    } else {
                        console.error('Âä†ËΩΩAIÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•:', await response.text());
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩAIÊ®°ÂûãÈÖçÁΩÆÂ§±Ë¥•:', error);
                }
            }

            // Ê∏≤ÊüìÈÖçÁΩÆÂàóË°®
            renderConfigList() {
                const container = document.getElementById('aiConfigList');
                if (!container) return;

                if (this.configs.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; color: #999; text-align: center;">ÊöÇÊó†AIÊ®°ÂûãÈÖçÁΩÆÔºåËØ∑Ê∑ªÂä†ÈÖçÁΩÆ</p>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ÂêçÁß∞</th>
                                <th>Ê®°ÂûãÂêçÁß∞</th>
                                <th>ËÆ¢ÈòÖÁ´ØÁÇπ</th>
                                <th>Áä∂ÊÄÅ</th>
                                <th>ÈªòËÆ§</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                this.configs.forEach(config => {
                    html += `
                        <tr>
                            <td>${config.name}</td>
                            <td>${config.modelName || '-'}</td>
                            <td>${config.subscribeEndpoint}</td>
                            <td>
                                <span class="${config.isActive ? 'status-active' : 'status-inactive'}">
                                    ${config.isActive ? 'ÊøÄÊ¥ª' : 'Êú™ÊøÄÊ¥ª'}
                                </span>
                            </td>
                            <td>
                                ${config.isDefault ? '‚úì' : ''}
                            </td>
                            <td>
                                <button class="btn btn-small" onclick="aiConfigManager.editConfig(${config.id})">ÁºñËæë</button>
                                <button class="btn btn-danger btn-small" onclick="aiConfigManager.deleteConfig(${config.id})">Âà†Èô§</button>
                                <button class="btn btn-small" onclick="aiConfigManager.testConfig(${config.id})">ÊµãËØï</button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;
            }

            // ÊòæÁ§∫ÂàõÂª∫ÈÖçÁΩÆË°®Âçï
            showCreateForm() {
                this.showConfigForm({
                    id: 0,
                    name: '',
                    apiKey: '',
                    subscribeEndpoint: '',
                    modelName: '',
                    isActive: false,
                    isDefault: false
                });
            }

            // ÊòæÁ§∫ÁºñËæëÈÖçÁΩÆË°®Âçï
            showConfigForm(config) {
                const form = document.getElementById('aiConfigForm');
                if (!form) return;

                document.getElementById('configId').value = config.id;
                document.getElementById('configName').value = config.name;
                document.getElementById('configApiKey').value = config.apiKey;
                document.getElementById('configSubscribeEndpoint').value = config.subscribeEndpoint;
                document.getElementById('configModelName').value = config.modelName || '';
                document.getElementById('configIsActive').checked = config.isActive;
                document.getElementById('configIsDefault').checked = config.isDefault;

                // ËÆæÁΩÆË°®ÂçïÊ†áÈ¢ò
                document.getElementById('formTitle').textContent = config.id === 0 ? 'Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ' : 'ÁºñËæëÈÖçÁΩÆ';
                
                form.style.display = 'block';
            }

            // ‰øùÂ≠òÈÖçÁΩÆ
            async saveConfig() {
                const config = {
                    id: parseInt(document.getElementById('configId').value),
                    name: document.getElementById('configName').value.trim(),
                    apiKey: document.getElementById('configApiKey').value.trim(),
                    subscribeEndpoint: document.getElementById('configSubscribeEndpoint').value.trim(),
                    modelName: document.getElementById('configModelName').value.trim(),
                    isActive: document.getElementById('configIsActive').checked,
                    isDefault: document.getElementById('configIsDefault').checked
                };

                if (!config.name || !config.apiKey || !config.subscribeEndpoint) {
                    alert('ËØ∑Â°´ÂÜôÂøÖÂ°´Â≠óÊÆµ');
                    return;
                }

                try {
                    let response;
                    if (config.id === 0) {
                        // ÂàõÂª∫Êñ∞ÈÖçÁΩÆ
                        response = await fetch(`${this.apiBase}/api/aimodelconfig`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                    } else {
                        // Êõ¥Êñ∞ÈÖçÁΩÆ
                        response = await fetch(`${this.apiBase}/api/aimodelconfig/${config.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                    }

                    if (response.ok) {
                        this.hideConfigForm();
                        await this.loadConfigs();
                        this.renderConfigList();
                        alert('‰øùÂ≠òÊàêÂäüÔºÅ');
                    } else {
                        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + await response.text());
                    }
                } catch (error) {
                    alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message);
                }
            }

            // ÁºñËæëÈÖçÁΩÆ
            async editConfig(id) {
                const config = this.configs.find(c => c.id === id);
                if (config) {
                    this.showConfigForm(config);
                }
            }

            // Âà†Èô§ÈÖçÁΩÆ
            async deleteConfig(id) {
                if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÈÖçÁΩÆÂêóÔºü')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await this.loadConfigs();
                        this.renderConfigList();
                        alert('Âà†Èô§ÊàêÂäüÔºÅ');
                    } else {
                        alert('Âà†Èô§Â§±Ë¥•Ôºö' + await response.text());
                    }
                } catch (error) {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message);
                }
            }

            // ÊµãËØïÈÖçÁΩÆËøûÊé•
            async testConfig(id) {
                const config = this.configs.find(c => c.id === id);
                if (!config) return;

                // ÊûÑÈÄ†ÊµãËØïËØ∑Ê±ÇÂØπË±°ÔºåÂè™ÂåÖÂê´ÂøÖË¶ÅÂ≠óÊÆµ
                const testRequest = {
                    apiKey: config.apiKey,
                    subscribeEndpoint: config.subscribeEndpoint,
                    modelName: config.modelName
                };

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testRequest)
                    });

                    if (response.ok) {
                        alert('ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ');
                    } else {
                        alert('ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + await response.text());
                    }
                } catch (error) {
                    alert('ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
                }
            }

            // ÂèñÊ∂àÁºñËæë
            cancelEdit() {
                this.hideConfigForm();
            }

            // ÈöêËóèÈÖçÁΩÆË°®Âçï
            hideConfigForm() {
                const form = document.getElementById('aiConfigForm');
                if (form) {
                    form.style.display = 'none';
                }
            }

            // ÊµãËØïËøûÊé•
            async testConnection() {
                const config = {
                    apiKey: document.getElementById('configApiKey').value.trim(),
                    subscribeEndpoint: document.getElementById('configSubscribeEndpoint').value.trim(),
                    modelName: document.getElementById('configModelName').value.trim()
                };

                if (!config.apiKey || !config.subscribeEndpoint || !config.modelName) {
                    alert('ËØ∑Â°´ÂÜôAPI Key„ÄÅËÆ¢ÈòÖÁ´ØÁÇπÂíåÊ®°ÂûãÂêçÁß∞');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        alert('ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ');
                    } else {
                        alert('ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + await response.text());
                    }
                } catch (error) {
                    alert('ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
                }
            }
        }

        // ÂàùÂßãÂåñAIÈÖçÁΩÆÁÆ°ÁêÜÂô®
        const aiConfigManager = new AIConfigManager();

        // ÊèêÁ§∫ËØçÁÆ°ÁêÜ
        class AIPromptManager {
            constructor() {
                this.prompts = [];
                this.apiBase = window.location.origin;
            }

            async init() {
                await this.loadPrompts();
                this.renderPromptList();
                // ÂàùÂßãÂåñAIÂàÜÊûê‰∏ãÊãâ
                this.fillPromptSelect();
            }

            async loadPrompts() {
                try {
                    const res = await fetch(`${this.apiBase}/api/aiprompts`);
                    this.prompts = res.ok ? await res.json() : [];
                    const container = document.getElementById('aiPromptList');
                    if (!container) return;
                    this.renderPromptList();
                } catch (e) {
                    console.error('Âä†ËΩΩÊèêÁ§∫ËØçÂ§±Ë¥•:', e);
                }
            }

            renderPromptList() {
                const container = document.getElementById('aiPromptList');
                if (!container) return;
                if (!this.prompts || this.prompts.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; color: #999; text-align: center;">ÊöÇÊó†ÊèêÁ§∫ËØçÔºåËØ∑Ê∑ªÂä†</p>';
                    return;
                }
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ÂêçÁß∞</th>
                                <th>Ê∏©Â∫¶</th>
                                <th>ÈªòËÆ§</th>
                                <th>ÂêØÁî®</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                this.prompts.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.temperature}</td>
                            <td>${p.isDefault ? '‚úì' : ''}</td>
                            <td>${p.isActive ? '‚úì' : ''}</td>
                            <td>
                                <button class="btn btn-small" onclick="aiPromptManager.editPrompt(${p.id})">ÁºñËæë</button>
                                <button class="btn btn-danger btn-small" onclick="aiPromptManager.deletePrompt(${p.id})">Âà†Èô§</button>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            }

            showCreateForm() {
                this.showPromptForm({
                    id: 0, name: '', systemPrompt: '', temperature: 0.7, isDefault: false, isActive: true
                });
            }

            showPromptForm(p) {
                document.getElementById('promptId').value = p.id;
                document.getElementById('promptName').value = p.name;
                document.getElementById('promptText').value = p.systemPrompt;
                document.getElementById('promptTemp').value = p.temperature;
                document.getElementById('promptIsDefault').checked = !!p.isDefault;
                document.getElementById('promptIsActive').checked = !!p.isActive;
                document.getElementById('promptFormTitle').textContent = p.id === 0 ? 'Ê∑ªÂä†Êñ∞ÊèêÁ§∫ËØç' : 'ÁºñËæëÊèêÁ§∫ËØç';
                document.getElementById('aiPromptForm').style.display = 'block';
            }

            async savePrompt() {
                const payload = {
                    id: parseInt(document.getElementById('promptId').value),
                    name: document.getElementById('promptName').value.trim(),
                    systemPrompt: document.getElementById('promptText').value.trim(),
                    temperature: parseFloat(document.getElementById('promptTemp').value),
                    isDefault: document.getElementById('promptIsDefault').checked,
                    isActive: document.getElementById('promptIsActive').checked
                };
                if (!payload.name || !payload.systemPrompt) {
                    alert('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÁ≥ªÁªüÊèêÁ§∫ËØç');
                    return;
                }
                try {
                    let res;
                    if (payload.id === 0) {
                        res = await fetch(`${this.apiBase}/api/aiprompts`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                    } else {
                        res = await fetch(`${this.apiBase}/api/aiprompts/${payload.id}`, {
                            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                    }
                    if (res.ok) {
                        await this.loadPrompts();
                        this.fillPromptSelect();
                        this.hidePromptForm();
                        alert('‰øùÂ≠òÊàêÂäüÔºÅ');
                    } else {
                        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + await res.text());
                    }
                } catch (e) {
                    alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + e.message);
                }
            }

            async editPrompt(id) {
                const p = this.prompts.find(x => x.id === id);
                if (p) this.showPromptForm(p);
            }

            async deletePrompt(id) {
                if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊèêÁ§∫ËØçÂêóÔºü')) return;
                try {
                    const res = await fetch(`${this.apiBase}/api/aiprompts/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        await this.loadPrompts();
                        this.fillPromptSelect();
                        alert('Âà†Èô§ÊàêÂäüÔºÅ');
                    } else {
                        alert('Âà†Èô§Â§±Ë¥•Ôºö' + await res.text());
                    }
                } catch (e) {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + e.message);
                }
            }

            cancelEdit() { this.hidePromptForm(); }
            hidePromptForm() { document.getElementById('aiPromptForm').style.display = 'none'; }

            // Â°´ÂÖÖAIÂàÜÊûê‰∏ãÊãâ
            fillPromptSelect() {
                const sel = document.getElementById('aiPromptSelect');
                if (!sel) return;
                let html = '<option value="">Ôºà‰ΩøÁî®ÈªòËÆ§ÊàñJSONÈÖçÁΩÆÔºâ</option>';
                this.prompts.filter(p => p.isActive).forEach(p => {
                    html += `<option value="${p.id}" ${p.isDefault ? 'selected' : ''}>${p.name}</option>`;
                });
                sel.innerHTML = html;
            }
        }

        // ÂàùÂßãÂåñÁÆ°ÁêÜÂô®
        const aiPromptManager = new AIPromptManager();

        // ÈÄâËÇ°Ê®°ÊùøÁÆ°ÁêÜ
        class ScreenTemplateManager {
            constructor() {
                this.templates = [];
                this.apiBase = window.location.origin;
                this.currentEditingId = null;
            }

            async init() {
                await this.loadTemplates();
                this.renderTemplateSelect();
            }

            async loadTemplates() {
                try {
                    const res = await fetch(`${this.apiBase}/api/screentemplates`);
                    this.templates = res.ok ? await res.json() : [];
                    this.renderTemplateSelect();
                } catch (e) {
                    console.error('Âä†ËΩΩÈÄâËÇ°Ê®°ÊùøÂ§±Ë¥•:', e);
                }
            }

            renderTemplateSelect() {
                const select = document.getElementById('templateSelect');
                if (!select) return;
                
                let html = '<option value="">ÈÄâÊã©Ê®°Êùø...</option>';
                this.templates.forEach(template => {
                    html += `<option value="${template.id}" ${template.isDefault ? 'selected' : ''}>${template.name}</option>`;
                });
                select.innerHTML = html;
            }

            async loadTemplate() {
                const templateId = document.getElementById('templateSelect').value;
                if (!templateId) return;

                try {
                    const res = await fetch(`${this.apiBase}/api/screentemplates/${templateId}`);
                    if (!res.ok) throw new Error('Âä†ËΩΩÊ®°ÊùøÂ§±Ë¥•');
                    
                    const template = await res.json();
                    this.fillFormWithTemplate(template);
                } catch (e) {
                    alert('Âä†ËΩΩÊ®°ÊùøÂ§±Ë¥•Ôºö' + e.message);
                }
            }

            fillFormWithTemplate(template) {
                // Â°´ÂÖÖË°®ÂçïÂ≠óÊÆµ
                document.getElementById('market').value = template.market || '';
                document.getElementById('minPrice').value = template.minPrice || '';
                document.getElementById('maxPrice').value = template.maxPrice || '';
                document.getElementById('minChange').value = template.minChangePercent || '';
                document.getElementById('maxChange').value = template.maxChangePercent || '';
                document.getElementById('minTurnover').value = template.minTurnoverRate || '';
                document.getElementById('maxTurnover').value = template.maxTurnoverRate || '';
                document.getElementById('minPE').value = template.minPE || '';
                document.getElementById('maxPE').value = template.maxPE || '';
                document.getElementById('minPB').value = template.minPB || '';
                document.getElementById('maxPB').value = template.maxPB || '';
                document.getElementById('minVolume').value = template.minVolume || '';
                document.getElementById('maxVolume').value = template.maxVolume || '';
                document.getElementById('minMarketValue').value = template.minMarketValue || '';
                document.getElementById('maxMarketValue').value = template.maxMarketValue || '';
                document.getElementById('minDividendYield').value = template.minDividendYield || '';
                document.getElementById('maxDividendYield').value = template.maxDividendYield || '';
            }

            showSaveDialog() {
                document.getElementById('saveTemplateTitle').textContent = '‰øùÂ≠òÈÄâËÇ°Ê®°Êùø';
                document.getElementById('templateName').value = '';
                document.getElementById('templateDescription').value = '';
                document.getElementById('setAsDefault').checked = false;
                this.currentEditingId = null;
                document.getElementById('saveTemplateModal').style.display = 'block';
            }

            showEditDialog() {
                const templateId = document.getElementById('templateSelect').value;
                if (!templateId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                    return;
                }

                const template = this.templates.find(t => t.id == templateId);
                if (!template) return;

                document.getElementById('saveTemplateTitle').textContent = 'ÁºñËæëÈÄâËÇ°Ê®°Êùø';
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateDescription').value = template.description || '';
                document.getElementById('setAsDefault').checked = template.isDefault;
                this.currentEditingId = templateId;
                document.getElementById('saveTemplateModal').style.display = 'block';
            }

            async saveTemplate() {
                const name = document.getElementById('templateName').value.trim();
                if (!name) {
                    alert('ËØ∑ËæìÂÖ•Ê®°ÊùøÂêçÁß∞');
                    return;
                }

                const templateData = {
                    name: name,
                    description: document.getElementById('templateDescription').value.trim(),
                    market: document.getElementById('market').value || null,
                    minPrice: parseFloat(document.getElementById('minPrice').value) || null,
                    maxPrice: parseFloat(document.getElementById('maxPrice').value) || null,
                    minChangePercent: parseFloat(document.getElementById('minChange').value) || null,
                    maxChangePercent: parseFloat(document.getElementById('maxChange').value) || null,
                    minTurnoverRate: parseFloat(document.getElementById('minTurnover').value) || null,
                    maxTurnoverRate: parseFloat(document.getElementById('maxTurnover').value) || null,
                    minPE: parseFloat(document.getElementById('minPE').value) || null,
                    maxPE: parseFloat(document.getElementById('maxPE').value) || null,
                    minPB: parseFloat(document.getElementById('minPB').value) || null,
                    maxPB: parseFloat(document.getElementById('maxPB').value) || null,
                    minVolume: parseFloat(document.getElementById('minVolume').value) || null,
                    maxVolume: parseFloat(document.getElementById('maxVolume').value) || null,
                    minMarketValue: parseFloat(document.getElementById('minMarketValue').value) || null,
                    maxMarketValue: parseFloat(document.getElementById('maxMarketValue').value) || null,
                    minDividendYield: parseFloat(document.getElementById('minDividendYield').value) || null,
                    maxDividendYield: parseFloat(document.getElementById('maxDividendYield').value) || null,
                    isDefault: document.getElementById('setAsDefault').checked
                };

                try {
                    let response;
                    if (this.currentEditingId) {
                        // Êõ¥Êñ∞Ê®°Êùø
                        response = await fetch(`${this.apiBase}/api/screentemplates/${this.currentEditingId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(templateData)
                        });
                    } else {
                        // ÂàõÂª∫Êñ∞Ê®°Êùø
                        response = await fetch(`${this.apiBase}/api/screentemplates`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(templateData)
                        });
                    }

                    if (response.ok) {
                        alert(this.currentEditingId ? 'Ê®°ÊùøÊõ¥Êñ∞ÊàêÂäüÔºÅ' : 'Ê®°Êùø‰øùÂ≠òÊàêÂäüÔºÅ');
                        this.hideSaveDialog();
                        await this.loadTemplates();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (e) {
                    alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + e.message);
                }
            }

            async deleteTemplate() {
                const templateId = document.getElementById('templateSelect').value;
                if (!templateId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                    return;
                }

                const template = this.templates.find(t => t.id == templateId);
                if (!template) return;

                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê®°Êùø"${template.name}"ÂêóÔºü`)) return;

                try {
                    const response = await fetch(`${this.apiBase}/api/screentemplates/${templateId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Ê®°ÊùøÂà†Èô§ÊàêÂäüÔºÅ');
                        await this.loadTemplates();
                        this.clearForm();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (e) {
                    alert('Âà†Èô§Â§±Ë¥•Ôºö' + e.message);
                }
            }

            clearForm() {
                document.getElementById('templateSelect').value = '';
                document.getElementById('market').value = '';
                document.getElementById('minPrice').value = '';
                document.getElementById('maxPrice').value = '';
                document.getElementById('minChange').value = '';
                document.getElementById('maxChange').value = '';
                document.getElementById('minTurnover').value = '';
                document.getElementById('maxTurnover').value = '';
                document.getElementById('minPE').value = '';
                document.getElementById('maxPE').value = '';
                document.getElementById('minPB').value = '';
                document.getElementById('maxPB').value = '';
                document.getElementById('minVolume').value = '';
                document.getElementById('maxVolume').value = '';
                document.getElementById('minMarketValue').value = '';
                document.getElementById('maxMarketValue').value = '';
                document.getElementById('minDividendYield').value = '';
                document.getElementById('maxDividendYield').value = '';
            }

            hideSaveDialog() {
                document.getElementById('saveTemplateModal').style.display = 'none';
            }
        }

        // ÂàùÂßãÂåñÈÄâËÇ°Ê®°ÊùøÁÆ°ÁêÜÂô®
        const screenTemplateManager = new ScreenTemplateManager();

        // ÂÖ®Â±ÄÂáΩÊï∞‰æõHTMLË∞ÉÁî®
        function loadTemplate() { screenTemplateManager.loadTemplate(); }
        function showSaveTemplateDialog() { screenTemplateManager.showSaveDialog(); }
        function showEditTemplateDialog() { screenTemplateManager.showEditDialog(); }
        function saveTemplate() { screenTemplateManager.saveTemplate(); }
        function deleteTemplate() { screenTemplateManager.deleteTemplate(); }
        function clearScreenForm() { screenTemplateManager.clearForm(); }
        function hideSaveTemplateDialog() { screenTemplateManager.hideSaveDialog(); }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.onload = function() {
            loadSettings();
            loadCategories();
            loadWatchlist();
            startAutoRefresh();
            updateLastRefreshTime();
            
            // ÂàùÂßãÂåñAIÈÖçÁΩÆÁÆ°ÁêÜÂô®
            aiConfigManager.init();
            aiPromptManager.init();
            
            // ÂàùÂßãÂåñÈÄâËÇ°Ê®°ÊùøÁÆ°ÁêÜÂô®
            screenTemplateManager.init();
        };

        // ÈáèÂåñ‰∫§ÊòìÁÆ°ÁêÜ
        const quantTrading = {
            // Âä†ËΩΩÁ≠ñÁï•ÂàóË°®
            async loadStrategies() {
                try {
                    // ‰øÆÂ§çÔºö‰ªéÈáèÂåñ‰∫§ÊòìÊéßÂà∂Âô®ËØªÂèñÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁ≠ñÁï•
                    const response = await fetch(`${API_BASE}/api/QuantTrading/strategies`);
                    const strategies = await response.json();

                    // ÁºìÂ≠ò‰ª•‰æøÂêéÁª≠Ê†πÊçÆÂêçÁß∞Êü•ÊâæID
                    this._strategies = Array.isArray(strategies) ? strategies : [];

                    const strategyList = document.getElementById('strategyList');
                    const strategySelect = document.getElementById('strategySelect');
                    
                    if (!Array.isArray(strategies) || strategies.length === 0) {
                        strategyList.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†Á≠ñÁï•ÔºåËØ∑ÂÖàÂØºÂÖ•ÈªòËÆ§Á≠ñÁï•</p>';
                        strategySelect.innerHTML = '<option value="">ÊöÇÊó†Á≠ñÁï•</option>';
                        return;
                    }
                    
                    // Èò≤Âæ°ÂºèËµÑÈáëÊòæÁ§∫Ôºö‰ºòÂÖàcurrentCapitalÔºåÂõûÈÄÄinitialCapitalÔºåÊ†ºÂºèÂåñÂ§±Ë¥•ÊòæÁ§∫-
                    strategyList.innerHTML = strategies.map(strategy => {
                        const cap = typeof strategy.currentCapital === 'number'
                            ? strategy.currentCapital
                            : (typeof strategy.initialCapital === 'number' ? strategy.initialCapital : undefined);
                        const capStr = typeof cap === 'number' ? `¬•${cap.toLocaleString()}` : '¬•-';

                        return `
                            <div class="stock-card" style="margin-bottom: 15px;">
                                <div class="stock-header">
                                    <div class="stock-name-section">
                                        <div class="stock-name">${strategy.name}</div>
                                        <div class="stock-code">${strategy.type} | ËµÑÈáë: ${capStr}</div>
                                    </div>
                                    <div class="stock-actions">
                                        <button class="btn btn-small ${strategy.isActive ? 'btn-success' : ''}" 
                                                onclick="quantTrading.toggleStrategy('${strategy.id}', ${!strategy.isActive})">
                                            ${strategy.isActive ? '‚úÖ Â∑≤ÂêØÁî®' : '‚è∏Ô∏è Â∑≤ÂÅúÁî®'}
                                        </button>
                                        <button class="btn btn-danger btn-small" 
                                                onclick="quantTrading.deleteStrategyById(${strategy.id}, '${strategy.name.replace(/'/g, "\\'")}')">üóëÔ∏è Âà†Èô§</button>
                                    </div>
                                </div>
                                <div class="price-section">
                                    <div style="font-size: 0.9em; color: #666;">${strategy.description || 'ÊöÇÊó†ÊèèËø∞'}</div>
                                    <div class="price-info-row" style="margin-top: 10px;">
                                        <div class="price-item">
                                            <span class="price-label">ÂàùÂßãËµÑÈáë</span>
                                            <span class="price-value">¬•${(typeof strategy.initialCapital === 'number' ? strategy.initialCapital.toLocaleString() : '-')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // ‰∏ãÊãâÊ°Ü‰ª•Áé∞ÊúâÁ≠ñÁï•ÂêçÂ°´ÂÖÖÔºå‰æø‰∫éÂä†ËΩΩÂØπÂ∫îÈÖçÁΩÆÊñá‰ª∂
                    strategySelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Á≠ñÁï•...</option>' + 
                        strategies.map(s => `<option value="${s.name}">${s.name} (${s.type})</option>`).join('');
                    
                    // ÂõûÊµãËÇ°Á•®ÈÄâÊã©‰∏ãÊãâÊ°ÜÂ∑≤Âú®loadWatchlist‰∏≠Ëá™Âä®Â°´ÂÖÖ
                        
                } catch (error) {
                    console.error('Âä†ËΩΩÁ≠ñÁï•Â§±Ë¥•:', error);
                    document.getElementById('strategyList').innerHTML = '<p style="color: red;">Âä†ËΩΩÁ≠ñÁï•Â§±Ë¥•</p>';
                }
            },

            // ÂØºÂÖ•ÈªòËÆ§Á≠ñÁï•
            async importDefaultStrategies() {
                try {
                    const response = await fetch(`${API_BASE}/api/StrategyConfig/import`, {
                        method: 'POST'
                    });

                    const contentType = response.headers.get('content-type') || '';
                    const isJson = contentType.includes('application/json');
                    const result = isJson ? await response.json() : await response.text();

                    if (response.ok) {
                        const imported = isJson ? (result.importedCount ?? result.count ?? 0) : 0;
                        alert(`ÊàêÂäüÂØºÂÖ• ${imported} ‰∏™Á≠ñÁï•`);
                        await this.loadStrategies();
                    } else {
                        const msg = isJson ? (result.message || 'ÂØºÂÖ•Â§±Ë¥•') : result;
                        alert('ÂØºÂÖ•Â§±Ë¥•: ' + msg);
                    }
                } catch (error) {
                    console.error('ÂØºÂÖ•Á≠ñÁï•Â§±Ë¥•:', error);
                    alert('ÂØºÂÖ•Á≠ñÁï•Â§±Ë¥•');
                }
            },

            // Âä†ËΩΩÁ≠ñÁï•ÈÖçÁΩÆ
            async loadStrategyConfig() {
                const strategyName = document.getElementById('strategySelect').value;
                const configForm = document.getElementById('strategyConfigForm');
                
                if (!strategyName) {
                    configForm.style.display = 'none';
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/StrategyConfig/configs/${encodeURIComponent(strategyName)}`);
                    const config = await response.json();
                    
                    if (response.ok) {
                        // Â°´ÂÖÖË°®Âçï
                        document.getElementById('strategyName').value = config.name;
                        document.getElementById('strategyDescription').value = config.description || '';
                        document.getElementById('initialCapital').value = config.initialCapital;
                        document.getElementById('strategyType').value = config.type;
                        document.getElementById('isActive').checked = config.isActive;
                        
                        // Âä†ËΩΩÁ≠ñÁï•ÂèÇÊï∞
                        this.loadStrategyParameters(config.type, config.parameters);
                        
                        configForm.style.display = 'block';
                    } else {
                        alert('Âä†ËΩΩÁ≠ñÁï•ÈÖçÁΩÆÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('Âä†ËΩΩÁ≠ñÁï•ÈÖçÁΩÆÂ§±Ë¥•:', error);
                    alert('Âä†ËΩΩÁ≠ñÁï•ÈÖçÁΩÆÂ§±Ë¥•');
                }
            },

            // Âä†ËΩΩÁ≠ñÁï•ÂèÇÊï∞Ë°®Âçï
            loadStrategyParameters(strategyType, parameters = {}) {
                const container = document.getElementById('strategyParameters');
                let html = '<h4>Á≠ñÁï•ÂèÇÊï∞</h4>';
                
                switch (strategyType) {
                    case 'MA_CROSS':
                        html += `
                            <div class="form-group">
                                <label>Áü≠ÊúüÂùáÁ∫øÂë®Êúü</label>
                                <input type="number" id="shortPeriod" value="${parameters.shortPeriod || 5}" min="1">
                            </div>
                            <div class="form-group">
                                <label>ÈïøÊúüÂùáÁ∫øÂë®Êúü</label>
                                <input type="number" id="longPeriod" value="${parameters.longPeriod || 20}" min="1">
                            </div>
                        `;
                        break;
                    case 'RSI':
                        html += `
                            <div class="form-group">
                                <label>RSIÂë®Êúü</label>
                                <input type="number" id="rsiPeriod" value="${parameters.rsiPeriod || 14}" min="1">
                            </div>
                            <div class="form-group">
                                <label>Ë∂Ö‰π∞ÈòàÂÄº</label>
                                <input type="number" id="overboughtThreshold" value="${parameters.overboughtThreshold || 70}" min="50" max="100">
                            </div>
                            <div class="form-group">
                                <label>Ë∂ÖÂçñÈòàÂÄº</label>
                                <input type="number" id="oversoldThreshold" value="${parameters.oversoldThreshold || 30}" min="0" max="50">
                            </div>
                        `;
                        break;
                    case 'BOLLINGER':
                        html += `
                            <div class="form-group">
                                <label>Â∏ÉÊûóÂ∏¶Âë®Êúü</label>
                                <input type="number" id="bollingerPeriod" value="${parameters.bollingerPeriod || 20}" min="1">
                            </div>
                            <div class="form-group">
                                <label>Ê†áÂáÜÂ∑ÆÂÄçÊï∞</label>
                                <input type="number" id="standardDeviation" value="${parameters.standardDeviation || 2}" min="0.1" step="0.1">
                            </div>
                        `;
                        break;
                }
                
                container.innerHTML = html;
            },

            // ‰øùÂ≠òÁ≠ñÁï•
            async saveStrategy() {
                const strategyName = document.getElementById('strategyName').value.trim();
                const strategyType = document.getElementById('strategyType').value;
                
                if (!strategyName) {
                    alert('ËØ∑ËæìÂÖ•Á≠ñÁï•ÂêçÁß∞');
                    return;
                }
                
                // Êî∂ÈõÜÁ≠ñÁï•ÂèÇÊï∞
                const parameters = this.collectStrategyParameters(strategyType);
                
                const config = {
                    name: strategyName,
                    description: document.getElementById('strategyDescription').value,
                    type: strategyType,
                    parameters: parameters,
                    initialCapital: parseFloat(document.getElementById('initialCapital').value),
                    isActive: document.getElementById('isActive').checked
                };
                
                try {
                    const response = await fetch(`${API_BASE}/api/StrategyConfig/configs`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        alert('Á≠ñÁï•‰øùÂ≠òÊàêÂäü');
                        this.loadStrategies();
                    } else {
                        const error = await response.text();
                        alert('‰øùÂ≠òÂ§±Ë¥•: ' + error);
                    }
                } catch (error) {
                    console.error('‰øùÂ≠òÁ≠ñÁï•Â§±Ë¥•:', error);
                    alert('‰øùÂ≠òÁ≠ñÁï•Â§±Ë¥•');
                }
            },

            // Êî∂ÈõÜÁ≠ñÁï•ÂèÇÊï∞
            collectStrategyParameters(strategyType) {
                const parameters = {};
                
                switch (strategyType) {
                    case 'MA_CROSS':
                        parameters.shortPeriod = parseInt(document.getElementById('shortPeriod').value);
                        parameters.longPeriod = parseInt(document.getElementById('longPeriod').value);
                        break;
                    case 'RSI':
                        parameters.rsiPeriod = parseInt(document.getElementById('rsiPeriod').value);
                        parameters.overboughtThreshold = parseFloat(document.getElementById('overboughtThreshold').value);
                        parameters.oversoldThreshold = parseFloat(document.getElementById('oversoldThreshold').value);
                        break;
                    case 'BOLLINGER':
                        parameters.bollingerPeriod = parseInt(document.getElementById('bollingerPeriod').value);
                        parameters.standardDeviation = parseFloat(document.getElementById('standardDeviation').value);
                        break;
                }
                
                return parameters;
            },

            // ËøêË°åÂõûÊµã
            async runBacktest() {
                const stockCode = document.getElementById('backtestStock').value.trim();
                const startDate = document.getElementById('backtestStartDate').value;
                const endDate = document.getElementById('backtestEndDate').value;
                const strategyName = document.getElementById('strategySelect').value;
                
                if (!stockCode || !startDate || !endDate || !strategyName) {
                    alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÂõûÊµãÂèÇÊï∞');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/Backtest/run`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            stockCode: stockCode,
                            strategyName: strategyName,
                            startDate: startDate,
                            endDate: endDate
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.displayBacktestResults(result);
                    } else {
                        alert('ÂõûÊµãÂ§±Ë¥•: ' + result.message);
                    }
                } catch (error) {
                    console.error('ÂõûÊµãÂ§±Ë¥•:', error);
                    alert('ÂõûÊµãÂ§±Ë¥•');
                }
            },

            // ÊòæÁ§∫ÂõûÊµãÁªìÊûú
            displayBacktestResults(result) {
                document.getElementById('totalReturn').textContent = (result.totalReturn * 100).toFixed(2) + '%';
                document.getElementById('annualReturn').textContent = (result.annualizedReturn * 100).toFixed(2) + '%';
                document.getElementById('maxDrawdown').textContent = (result.maxDrawdown * 100).toFixed(2) + '%';
                document.getElementById('sharpeRatio').textContent = result.sharpeRatio.toFixed(2);
                document.getElementById('tradeCount').textContent = result.totalTrades;
                document.getElementById('winRate').textContent = (result.winRate * 100).toFixed(1) + '%';
                
                // ÊòæÁ§∫‰∫§ÊòìËÆ∞ÂΩï
                const tradeHistory = document.getElementById('tradeHistory');
                if (result.trades && result.trades.length > 0) {
                    tradeHistory.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Êó•Êúü</th>
                                    <th>Á±ªÂûã</th>
                                    <th>‰ª∑Ê†º</th>
                                    <th>Êï∞Èáè</th>
                                    <th>ÈáëÈ¢ù</th>
                                    <th>Êî∂Áõä</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.trades.map(trade => `
                                    <tr>
                                        <td>${new Date(trade.date).toLocaleDateString()}</td>
                                        <td style="color: ${trade.type === 'BUY' ? '#f44336' : '#4caf50'}">${trade.type === 'BUY' ? '‰π∞ÂÖ•' : 'ÂçñÂá∫'}</td>
                                        <td>¬•${trade.price.toFixed(2)}</td>
                                        <td>${trade.quantity}</td>
                                        <td>¬•${(trade.price * trade.quantity).toFixed(2)}</td>
                                        <td style="color: ${trade.profit >= 0 ? '#f44336' : '#4caf50'}">${trade.profit ? trade.profit.toFixed(2) + '%' : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    tradeHistory.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</p>';
                }
                
                document.getElementById('backtestResults').style.display = 'block';
            },

            // ÂàáÊç¢Á≠ñÁï•Áä∂ÊÄÅ
            async toggleStrategy(strategyId, isActive) {
                try {
                    const response = await fetch(`${API_BASE}/api/QuantTrading/strategies/${strategyId}/toggle`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        this.loadStrategies();
                    } else {
                        alert('ÂàáÊç¢Á≠ñÁï•Áä∂ÊÄÅÂ§±Ë¥•');
                    }
                } catch (error) {
                    console.error('ÂàáÊç¢Á≠ñÁï•Áä∂ÊÄÅÂ§±Ë¥•:', error);
                    alert('ÂàáÊç¢Á≠ñÁï•Áä∂ÊÄÅÂ§±Ë¥•');
                }
            },

            // ÊòæÁ§∫ÂàõÂª∫Á≠ñÁï•Ë°®Âçï
            showCreateStrategy() {
                document.getElementById('strategySelect').value = '';
                document.getElementById('strategyName').value = '';
                document.getElementById('strategyDescription').value = '';
                document.getElementById('initialCapital').value = '100000';
                document.getElementById('strategyType').value = 'MA_CROSS';
                document.getElementById('isActive').checked = true;
                
                this.loadStrategyParameters('MA_CROSS');
                document.getElementById('strategyConfigForm').style.display = 'block';
            },

            // Âà†Èô§Á≠ñÁï•ÔºàÊåâÈÄâÊã©ÁöÑÁ≠ñÁï•ÂêçÁß∞ -> Êò†Â∞ÑÂà∞IDÂÜçÂà†Èô§Ôºâ
            async deleteStrategy() {
                const strategyName = document.getElementById('strategySelect').value;
                if (!strategyName) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÁ≠ñÁï•');
                    return;
                }

                const match = (this._strategies || []).find(s => s.name === strategyName);
                if (!match) {
                    alert('Êú™ÊâæÂà∞ËØ•Á≠ñÁï•ÔºåËØ∑ÂÖàÂà∑Êñ∞Á≠ñÁï•ÂàóË°®');
                    return;
                }

                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Á≠ñÁï• "${strategyName}" ÂêóÔºü`)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/QuantTrading/strategies/${match.id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Á≠ñÁï•Âà†Èô§ÊàêÂäü');
                        document.getElementById('strategyConfigForm').style.display = 'none';
                        this.loadStrategies();
                    } else {
                        const txt = await response.text();
                        alert('Âà†Èô§Á≠ñÁï•Â§±Ë¥•Ôºö' + txt);
                    }
                } catch (error) {
                    console.error('Âà†Èô§Á≠ñÁï•Â§±Ë¥•:', error);
                    alert('Âà†Èô§Á≠ñÁï•Â§±Ë¥•');
                }
            },

            // Êñ∞Â¢ûÔºöÊåâIDÂà†Èô§ÔºàÂç°Áâá‰∏äÁöÑÂà†Èô§ÊåâÈíÆË∞ÉÁî®Ôºâ
            async deleteStrategyById(id, name) {
                if (!id) {
                    alert('Á≠ñÁï•IDÁº∫Â§±');
                    return;
                }
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Á≠ñÁï• "${name}" ÂêóÔºü`)) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/QuantTrading/strategies/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Á≠ñÁï•Âà†Èô§ÊàêÂäü');
                        this.loadStrategies();
                    } else {
                        const txt = await response.text();
                        alert('Âà†Èô§Á≠ñÁï•Â§±Ë¥•Ôºö' + txt);
                    }
                } catch (error) {
                    console.error('Âà†Èô§Á≠ñÁï•Â§±Ë¥•:', error);
                    alert('Âà†Èô§Á≠ñÁï•Â§±Ë¥•');
                }
            },

            // ÊµãËØïÁ≠ñÁï•
            async testStrategy() {
                alert('Á≠ñÁï•ÊµãËØïÂäüËÉΩÂºÄÂèë‰∏≠...');
            },

            // ÂºÄÂßãÁõëÊéß
            startMonitoring() {
                document.getElementById('monitoringStatus').innerHTML = '<span style="color: #28a745;">‚úÖ ÁõëÊéßÂ∑≤ÂêØÂä®</span>';
                alert('ÂÆûÊó∂ÁõëÊéßÂäüËÉΩÂºÄÂèë‰∏≠...');
            },

            // ÂÅúÊ≠¢ÁõëÊéß
            stopMonitoring() {
                document.getElementById('monitoringStatus').innerHTML = '<span style="color: #dc3545;">‚èπÔ∏è ÁõëÊéßÂ∑≤ÂÅúÊ≠¢</span>';
            },

            // Âä†ËΩΩÊ¥ªË∑ÉÁ≠ñÁï•
            async loadActiveStrategies() {
                try {
                    const response = await fetch(`${API_BASE}/api/QuantTrading/strategies/active`);
                    const strategies = await response.json();
                    
                    const container = document.getElementById('activeStrategies');
                    if (strategies.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†Ê¥ªË∑ÉÁ≠ñÁï•</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <h4>Ê¥ªË∑ÉÁ≠ñÁï• (${strategies.length})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                            ${strategies.map(strategy => `
                                <div class="stock-card">
                                    <div class="stock-header">
                                        <div class="stock-name-section">
                                            <div class="stock-name">${strategy.name}</div>
                                            <div class="stock-code">${strategy.type}</div>
                                        </div>
                                        <div class="category-label cost-positive">ËøêË°å‰∏≠</div>
                                    </div>
                                    <div class="price-section">
                                        <div class="price-info-row">
                                            <div class="price-item">
                                                <span class="price-label">ÂΩìÂâçËµÑÈáë</span>
                                                <span class="price-value">¬•${strategy.currentCapital.toLocaleString()}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">Êî∂ÁõäÁéá</span>
                                                <span class="price-value ${strategy.currentCapital >= strategy.initialCapital ? 'price-up' : 'price-down'}">
                                                    ${((strategy.currentCapital - strategy.initialCapital) / strategy.initialCapital * 100).toFixed(2)}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (error) {
                    console.error('Âä†ËΩΩÊ¥ªË∑ÉÁ≠ñÁï•Â§±Ë¥•:', error);
                    document.getElementById('activeStrategies').innerHTML = '<p style="color: red;">Âä†ËΩΩÂ§±Ë¥•</p>';
                }
            },

            // Âä†ËΩΩËá™ÈÄâËÇ°Âà∞ÂõûÊµãËÇ°Á•®ÈÄâÊã©‰∏ãÊãâÊ°ÜÔºàÂ∑≤Êï¥ÂêàÂà∞loadWatchlist‰∏≠Ôºâ
            async loadWatchlistForBacktest() {
                // Ê≠§ÊñπÊ≥ïÂ∑≤Êï¥ÂêàÂà∞loadWatchlist‰∏≠Ôºå‰øùÁïô‰ª•ÂÖºÂÆπÁé∞ÊúâË∞ÉÁî®
                console.log('loadWatchlistForBacktestÂ∑≤Êï¥ÂêàÂà∞loadWatchlist‰∏≠');
            },

            // Êñ∞Â¢ûÔºöÂΩìÈÄâÊã©‰∏ãÊãâÊ°ÜÂõûÊµãËÇ°Á•®Êó∂ÔºåÂêåÊ≠•Âà∞ËæìÂÖ•Ê°Ü
            onBacktestStockChange() {
                const sel = document.getElementById('backtestStockSelect');
                const input = document.getElementById('backtestStock');
                if (sel && input) {
                    input.value = sel.value || '';
                }
            }
        };

        // ‰øÆÊîπswitchTabÂáΩÊï∞ÔºåÊ∑ªÂä†ÈáèÂåñ‰∫§ÊòìÈÄâÈ°πÂç°ÁöÑÂ§ÑÁêÜ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Ê†πÊçÆTabÂä†ËΩΩÊï∞ÊçÆ
            switch(tabName) {
                case 'watchlist':
                    loadWatchlist();
                    break;
                case 'quant':
                    quantTrading.loadStrategies();
                    // ËÆæÁΩÆÈªòËÆ§Êó•Êúü
                    const today = new Date();
                    const oneMonthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    document.getElementById('backtestStartDate').value = oneMonthAgo.toISOString().split('T')[0];
                    document.getElementById('backtestEndDate').value = today.toISOString().split('T')[0];
                    break;
                case 'news':
                    loadNews();
                    break;
                case 'alert':
                    loadAlerts();
                    break;
                case 'settings':
                    loadNewsRefreshSettings();
                    break;
            }
        }
    </script>
    
    <!-- ‰øùÂ≠òÈÄâËÇ°Ê®°ÊùøÂØπËØùÊ°Ü -->
    <div id="saveTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="saveTemplateTitle">‰øùÂ≠òÈÄâËÇ°Ê®°Êùø</h3>
                <span class="close" onclick="hideSaveTemplateDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ê®°ÊùøÂêçÁß∞ *</label>
                    <input type="text" id="templateName" placeholder="ËæìÂÖ•Ê®°ÊùøÂêçÁß∞" required>
                </div>
                <div class="form-group">
                    <label>Ê®°ÊùøÊèèËø∞</label>
                    <textarea id="templateDescription" placeholder="ËæìÂÖ•Ê®°ÊùøÊèèËø∞ÔºàÂèØÈÄâÔºâ" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setAsDefault"> ËÆæ‰∏∫ÈªòËÆ§Ê®°Êùø
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveTemplate()">üíæ ‰øùÂ≠ò</button>
                <button class="btn" style="background: #6c757d;" onclick="hideSaveTemplateDialog()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
</body>
</html>

