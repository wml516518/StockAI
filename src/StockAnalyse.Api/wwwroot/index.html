<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border-right: 1px solid #ddd;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
            display: none;
        }
        
        .content.active {
            display: block;
        }
        
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        table tr:hover {
            background: #f5f5f5;
        }
        
        /* è‡ªé€‰è‚¡å¡ç‰‡æ ·å¼ */
        .stock-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stock-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stock-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .stock-name-section {
            flex: 1;
        }
        
        .stock-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .price-section {
            margin: 15px 0;
        }
        
        .current-price {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-info-row {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .price-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .price-label {
            color: #666;
            font-size: 0.85em;
        }
        
        .price-value {
            font-weight: bold;
        }
        
        .market-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .cost-info {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .cost-positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .cost-negative {
            background: #ffebee;
            color: #c62828;
        }
        
        .category-label {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .price-up {
            color: #f44336;
        }
        
        .price-down {
            color: #4caf50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
            <p>å®æ—¶è¡Œæƒ… Â· æŠ€æœ¯åˆ†æ Â· æ™ºèƒ½æ¨è</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('watchlist')">è‡ªé€‰è‚¡</div>
            <div class="tab" onclick="switchTab('screen')">æ¡ä»¶é€‰è‚¡</div>
            <div class="tab" onclick="switchTab('news')">é‡‘èæ–°é—»</div>
            <div class="tab" onclick="switchTab('ai')">AIåˆ†æ</div>
            <div class="tab" onclick="switchTab('alert')">ä»·æ ¼æé†’</div>
            <div class="tab" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</div>
        </div>
        
        <!-- è‡ªé€‰è‚¡ -->
        <div id="watchlist" class="content active">
            <div class="card">
                <h3>æ·»åŠ è‡ªé€‰è‚¡</h3>
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000001ï¼‰</label>
                    <input type="text" id="stockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="categorySelect" style="flex: 1;">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                        <button class="btn" onclick="showCreateCategory()">+ æ–°å»ºåˆ†ç±»</button>
                    </div>
                </div>
                <button class="btn" onclick="addToWatchlist()">æ·»åŠ åˆ°è‡ªé€‰è‚¡</button>
            </div>
            
            <!-- åˆ›å»ºåˆ†ç±»å¯¹è¯æ¡† -->
            <div id="createCategoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div class="card" style="max-width: 500px; width: 90%; margin: 0;">
                    <h3 style="margin-bottom: 20px;">åˆ›å»ºæ–°åˆ†ç±»</h3>
                    <div class="form-group">
                        <label>åˆ†ç±»åç§° *</label>
                        <input type="text" id="categoryName" placeholder="å¦‚ï¼šå·²è´­ã€é¢„è´­ã€å…³æ³¨">
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <input type="text" id="categoryDesc" placeholder="åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label>é¢œè‰²</label>
                        <input type="color" id="categoryColor" value="#1890ff">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="createCategory()">åˆ›å»º</button>
                        <button class="btn" style="background: #6c757d;" onclick="hideCreateCategory()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0;">æˆ‘çš„è‡ªé€‰è‚¡</h3>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #666;">
                            è‡ªåŠ¨åˆ·æ–°: <span id="refreshStatus">å·²å¯ç”¨</span> | 
                            é—´éš”: <span id="refreshInterval">3</span>ç§’
                        </p>
                    </div>
                    <button class="btn" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">â¸ï¸ æš‚åœ</button>
                </div>
                <div id="watchlistList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- æ¡ä»¶é€‰è‚¡ -->
        <div id="screen" class="content">
            <div class="card">
                <h3>è®¾ç½®é€‰è‚¡æ¡ä»¶</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ä»·æ ¼åŒºé—´ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="minPrice" placeholder="æœ€ä½ä»·">
                        <input type="number" id="maxPrice" placeholder="æœ€é«˜ä»·" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>æ¶¨è·Œå¹…ï¼ˆ%ï¼‰</label>
                        <input type="number" id="minChange" placeholder="æœ€ä½æ¶¨å¹…">
                        <input type="number" id="maxChange" placeholder="æœ€é«˜æ¶¨å¹…" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>æ¢æ‰‹ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="minTurnover" placeholder="æœ€ä½æ¢æ‰‹ç‡">
                    </div>
                    <div class="form-group">
                        <label>å¸‚ç›ˆç‡ï¼ˆPEï¼‰</label>
                        <input type="number" id="minPE" placeholder="æœ€ä½PE">
                        <input type="number" id="maxPE" placeholder="æœ€é«˜PE" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>å¸‚å‡€ç‡ï¼ˆPBï¼‰</label>
                        <input type="number" id="minPB" placeholder="æœ€ä½PB">
                        <input type="number" id="maxPB" placeholder="æœ€é«˜PB" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>æˆäº¤é‡ï¼ˆæ‰‹ï¼‰</label>
                        <input type="number" id="minVolume" placeholder="æœ€ä½æˆäº¤é‡">
                        <input type="number" id="maxVolume" placeholder="æœ€é«˜æˆäº¤é‡" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>å¸‚å€¼åŒºé—´ï¼ˆäº¿å…ƒï¼‰</label>
                        <input type="number" id="minMarketValue" placeholder="æœ€ä½å¸‚å€¼">
                        <input type="number" id="maxMarketValue" placeholder="æœ€é«˜å¸‚å€¼" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>è‚¡æ¯ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="minDividendYield" placeholder="æœ€ä½è‚¡æ¯ç‡">
                        <input type="number" id="maxDividendYield" placeholder="æœ€é«˜è‚¡æ¯ç‡" style="margin-top: 5px;">
                    </div>
                </div>
                <button class="btn" onclick="screenStocks()">å¼€å§‹é€‰è‚¡</button>
            </div>
            
            <div class="card">
                <h3>é€‰è‚¡ç»“æœ</h3>
                <div id="screenResults" class="loading">ç­‰å¾…æŸ¥è¯¢...</div>
            </div>
        </div>
        
        <!-- é‡‘èæ–°é—» -->
        <div id="news" class="content">
            <div class="card">
                <h3>æœ€æ–°é‡‘èæ–°é—»</h3>
                <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newsSearch" placeholder="æœç´¢æ–°é—»å…³é”®è¯" style="flex: 1;">
                    <button class="btn" onclick="searchNews()">ğŸ” æœç´¢</button>
                    <button class="btn" onclick="fetchLatestNews()">ğŸ”„ æŠ“å–æœ€æ–°æ–°é—»</button>
                </div>
                <div id="newsList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- AIåˆ†æ -->
        <div id="ai" class="content">
            <div class="card">
                <h3>AIè‚¡ç¥¨åˆ†æ</h3>
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="aiStockCode" placeholder="è¾“å…¥è¦åˆ†æçš„è‚¡ç¥¨ä»£ç ">
                </div>
                <button class="btn" onclick="analyzeStock()">å¼€å§‹åˆ†æ</button>
                <div id="aiResult" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap;"></div>
            </div>
        </div>
        
        <!-- ä»·æ ¼æé†’ -->
        <div id="alert" class="content">
            <div class="card">
                <h3>åˆ›å»ºä»·æ ¼æé†’</h3>
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="alertStockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ">
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡ä»·æ ¼</label>
                    <input type="number" step="0.01" id="alertPrice" placeholder="è¾“å…¥ç›®æ ‡ä»·æ ¼">
                </div>
                <div class="form-group">
                    <label>æé†’ç±»å‹</label>
                    <select id="alertType">
                        <option value="PriceUp">ä»·æ ¼æ¶¨åˆ°ç›®æ ‡ä»·</option>
                        <option value="PriceDown">ä»·æ ¼è·Œåˆ°ç›®æ ‡ä»·</option>
                        <option value="PriceReach">ä»·æ ¼åˆ°è¾¾ç›®æ ‡ä»·</option>
                    </select>
                </div>
                <button class="btn" onclick="createAlert()">åˆ›å»ºæé†’</button>
            </div>
            
            <div class="card">
                <h3>æ´»è·ƒæé†’</h3>
                <div id="alertsList" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- è®¾ç½® -->
        <div id="settings" class="content">
            <div class="card">
                <h3>è‚¡ç¥¨è¡Œæƒ…è‡ªåŠ¨åˆ·æ–°è®¾ç½®</h3>
                <div class="form-group">
                    <label>åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="autoRefreshInterval" min="0.5" max="60" step="0.5" value="3">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        æ¨èè®¾ç½®ï¼š0.5-2ç§’ï¼ˆå®æ—¶ï¼‰ | 3-5ç§’ï¼ˆå¸¸è§„ï¼‰ | 10-30ç§’ï¼ˆçœæµé‡ï¼‰
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableAutoRefresh" checked>
                        å¯ç”¨è‡ªåŠ¨åˆ·æ–°
                    </label>
                </div>
                <button class="btn" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            </div>
            
            <div class="card">
                <h3>é‡‘èæ¶ˆæ¯å®šæ—¶åˆ·æ–°è®¾ç½®</h3>
                <div class="form-group">
                    <label>æ–°é—»åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="newsRefreshInterval" min="5" max="1440" step="5" value="30">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        æ¨èè®¾ç½®ï¼š5-15åˆ†é’Ÿï¼ˆé«˜é¢‘ï¼‰ | 30-60åˆ†é’Ÿï¼ˆå¸¸è§„ï¼‰ | 120åˆ†é’Ÿä»¥ä¸Šï¼ˆä½é¢‘ï¼‰
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNewsAutoRefresh" checked>
                        å¯ç”¨æ–°é—»è‡ªåŠ¨åˆ·æ–°
                    </label>
                </div>
                <div class="form-group">
                    <button class="btn" onclick="updateNewsRefreshSettings()">ğŸ’¾ æ›´æ–°æ–°é—»åˆ·æ–°è®¾ç½®</button>
                    <button class="btn" onclick="forceRefreshNews()" style="margin-left: 10px;">ğŸ”„ ç«‹å³åˆ·æ–°æ–°é—»</button>
                </div>
            </div>
            
            <div class="card">
                <h3>å½“å‰çŠ¶æ€</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">åˆ·æ–°é—´éš”</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="currentInterval">3ç§’</div>
                    </div>
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">è‡ªåŠ¨åˆ·æ–°çŠ¶æ€</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="currentStatus">å·²å¯ç”¨</div>
                    </div>
                    <div style="padding: 15px; background: #f0f7ff; border-radius: 5px;">
                        <div style="font-size: 0.9em; color: #666;">ä¸Šæ¬¡åˆ·æ–°</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: #666;" id="lastRefreshTime">--</div>
                    </div>
                </div>
            </div>
            
            <!-- AIæ¨¡å‹é…ç½® -->
            <div class="card">
                <h3>AIæ¨¡å‹é…ç½®</h3>
                <div class="form-group">
                    <button class="btn" onclick="aiConfigManager.loadConfigs()">ğŸ”„ åˆ·æ–°é…ç½®åˆ—è¡¨</button>
                    <button class="btn" onclick="aiConfigManager.showCreateForm()" style="margin-left: 10px;">â• æ·»åŠ é…ç½®</button>
                </div>
                
                <!-- é…ç½®åˆ—è¡¨ -->
                <div id="aiConfigList" class="loading">åŠ è½½ä¸­...</div>
                
                <!-- æ·»åŠ /ç¼–è¾‘è¡¨å• -->
                <div id="aiConfigForm" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #eee; border-radius: 5px;">
                    <h4 id="formTitle">æ·»åŠ æ–°é…ç½®</h4>
                    <input type="hidden" id="configId">
                    <div class="form-group">
                        <label>é…ç½®åç§° *</label>
                        <input type="text" id="configName" class="form-control" placeholder="ä¾‹å¦‚ï¼šé€šä¹‰åƒé—®API">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="password" id="configApiKey" class="form-control" placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                    </div>
                    <div class="form-group">
                        <label>è®¢é˜…ç«¯ç‚¹ *</label>
                        <input type="text" id="configSubscribeEndpoint" class="form-control" placeholder="ä¾‹å¦‚ï¼šhttps://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹åç§° *</label>
                        <input type="text" id="configModelName" class="form-control" placeholder="ä¾‹å¦‚ï¼šqwen-max">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsActive">
                            è®¾ä¸ºæ¿€æ´»çŠ¶æ€
                        </label>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            æ¿€æ´»çŠ¶æ€ä¸‹ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æ­¤é…ç½®è¿›è¡ŒAIåˆ†æ
                        </p>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsDefault">
                            è®¾ä¸ºé»˜è®¤é…ç½®
                        </label>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            é»˜è®¤é…ç½®å°†åœ¨åˆ›å»ºæ–°é…ç½®æ—¶è‡ªåŠ¨é€‰ä¸­
                        </p>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="aiConfigManager.saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button class="btn btn-secondary" onclick="aiConfigManager.cancelEdit()">å–æ¶ˆ</button>
                        <button class="btn btn-danger" onclick="aiConfigManager.testConnection()" style="float: right;">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshTimer = null;
        let autoRefreshInterval = 3; // é»˜è®¤3ç§’
        let autoRefreshEnabled = true;
        
        // Tabåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // æ ¹æ®TabåŠ è½½æ•°æ®
            switch(tabName) {
                case 'watchlist':
                    loadWatchlist();
                    break;
                case 'news':
                    loadNews();
                    break;
                case 'alert':
                    loadAlerts();
                    break;
                case 'settings':
                    loadNewsRefreshSettings();
                    break;
            }
        }
        
        // æ·»åŠ è‡ªé€‰è‚¡
        async function addToWatchlist() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const categoryId = document.getElementById('categorySelect').value;
            
            if (!stockCode || !categoryId) {
                alert('è¯·å¡«å†™è‚¡ç¥¨ä»£ç å’Œé€‰æ‹©åˆ†ç±»');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stockCode, categoryId: parseInt(categoryId) })
                });
                
                if (response.ok) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('stockCode').value = '';
                    loadWatchlist();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + await response.text());
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½è‡ªé€‰è‚¡
        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('åŠ è½½çš„è‡ªé€‰è‚¡æ•°æ®ï¼š', data); // è°ƒè¯•ç”¨
                console.log('è‡ªé€‰è‚¡æ•°æ®è¯¦ç»†ï¼š', JSON.stringify(data, null, 2)); // è¯¦ç»†è°ƒè¯•
                
                let html = '';
                if (!data || Object.keys(data).length === 0) {
                    html = '<p style="padding: 20px; color: #999; text-align: center;">æš‚æ— è‡ªé€‰è‚¡ï¼Œè¯·æ·»åŠ è‚¡ç¥¨</p>';
                } else {
                    for (const [category, stocks] of Object.entries(data)) {
                        html += `<h4 style="margin-top: 20px; color: #667eea; font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">${category}</h4>`;
                        html += '<div class="stock-cards">';
                        
                        stocks.forEach(stock => {
                            const stockData = stock.stock || {};
                            const currentPrice = stockData.currentPrice || stockData?.currentPrice || 0;
                            const changePercent = stockData.changePercent || stockData?.changePercent || 0;
                            const isPositive = changePercent >= 0;
                            const categoryColor = stock.category?.color || '#667eea';
                            
                            // éªŒè¯ä»·æ ¼æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                            const isValidPrice = currentPrice && currentPrice > 0;
                            
                            const stockName = stockData?.name || stockData?.Name || 'N/A';
                            console.log('å¤„ç†è‚¡ç¥¨ï¼š', stock.stockCode, 'è‚¡ç¥¨åç§°ï¼š', stockName, 'è‚¡ç¥¨æ•°æ®ï¼š', stockData); // è°ƒè¯•ç”¨
                            
                            html += `
                                <div class="stock-card" id="card-${stock.stockCode}">
                                    <div class="category-label" style="background: ${categoryColor}20; color: ${categoryColor};">
                                        ${category}
                                    </div>
                                    <div class="stock-header">
                                        <div class="stock-name-section">
                                            <div class="stock-name">${stockData.name || 'N/A'}</div>
                                            <div class="stock-code">${stock.stockCode}</div>
                                        </div>
                                        <div class="stock-actions">
                                            <button class="btn btn-small" onclick="openAI('${stock.stockCode}')">AIåˆ†æ</button>
                                            <button class="btn btn-danger btn-small" onclick="removeStock(${stock.id})">åˆ é™¤</button>
                                        </div>
                                    </div>
                                    <div class="price-section">
                                        <div class="current-price ${isValidPrice ? (isPositive ? 'price-up' : 'price-down') : ''}">
                                            ${isValidPrice ? currentPrice.toFixed(2) : 'æš‚æ— æ•°æ®'}
                                        </div>
                                        ${isValidPrice ? `
                                        <div class="price-info-row">
                                            <div>
                                                <span class="${isPositive ? 'price-up' : 'price-down'}">
                                                    ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">æœ€é«˜</span>
                                                <span class="price-value">${stockData.highPrice ? stockData.highPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">æœ€ä½</span>
                                                <span class="price-value">${stockData.lowPrice ? stockData.lowPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="price-info-row">
                                            <div class="price-item">
                                                <span class="price-label">ä»Šå¼€</span>
                                                <span class="price-value">${stockData.openPrice ? stockData.openPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">æ˜¨æ”¶</span>
                                                <span class="price-value">${stockData.closePrice ? stockData.closePrice.toFixed(2) : (stockData.prevClose ? stockData.prevClose.toFixed(2) : 'N/A')}</span>
                                            </div>
                                        </div>
                                        ` : `
                                        <div class="price-info-row">
                                            <div class="no-data">æš‚æ— æœ‰æ•ˆä»·æ ¼æ•°æ®</div>
                                        </div>
                                        `}
                                    </div>
                                    <div class="market-info">
                                        <div style="color: #666;">
                                            æˆäº¤é‡: ${stockData.volume ? (stockData.volume / 10000).toFixed(2) + 'ä¸‡' : 'N/A'}
                                        </div>
                                        <div class="cost-info ${stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative'}">
                                            æˆæœ¬: ${stock.costPrice ? stock.costPrice.toFixed(2) : '-'} Ã— ${stock.quantity || '-'}<br>
                                            ç›ˆäº: <strong>${stock.profitLoss !== undefined ? stock.profitLoss.toFixed(2) : '-'}</strong>
                                            (${stock.profitLossPercent !== undefined ? stock.profitLossPercent.toFixed(2) : '-'}%)
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                }
                
                document.getElementById('watchlistList').innerHTML = html;
            } catch (error) {
                document.getElementById('watchlistList').innerHTML = '<p>åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // æ¡ä»¶é€‰è‚¡
        async function screenStocks() {
            const criteria = {
                minPrice: parseFloat(document.getElementById('minPrice').value) || null,
                maxPrice: parseFloat(document.getElementById('maxPrice').value) || null,
                minChangePercent: parseFloat(document.getElementById('minChange').value) || null,
                maxChangePercent: parseFloat(document.getElementById('maxChange').value) || null,
                minTurnoverRate: parseFloat(document.getElementById('minTurnover').value) || null,
                minPE: parseFloat(document.getElementById('minPE').value) || null,
                maxPE: parseFloat(document.getElementById('maxPE').value) || null,
                minPB: parseFloat(document.getElementById('minPB').value) || null,
                maxPB: parseFloat(document.getElementById('maxPB').value) || null,
                minVolume: parseFloat(document.getElementById('minVolume').value) || null,
                maxVolume: parseFloat(document.getElementById('maxVolume').value) || null,
                minMarketValue: parseFloat(document.getElementById('minMarketValue').value) || null,
                maxMarketValue: parseFloat(document.getElementById('maxMarketValue').value) || null,
                minDividendYield: parseFloat(document.getElementById('minDividendYield').value) || null,
                maxDividendYield: parseFloat(document.getElementById('maxDividendYield').value) || null
            };
            
            try {
                document.getElementById('screenResults').innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
                const response = await fetch(`${API_BASE}/api/screen/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(criteria)
                });
                
                const stocks = await response.json();
                
                let html = `<p>æ‰¾åˆ° ${stocks.length} åªè‚¡ç¥¨</p><table><thead><tr><th>ä»£ç </th><th>åç§°</th><th>å½“å‰ä»·</th><th>æ¶¨è·Œå¹…</th><th>æ¢æ‰‹ç‡</th><th>PE</th><th>PB</th><th>æˆäº¤é‡</th></tr></thead><tbody>`;
                
                stocks.forEach(stock => {
                    html += `
                        <tr>
                            <td>${stock.code}</td>
                            <td>${stock.name}</td>
                            <td>${stock.currentPrice.toFixed(2)}</td>
                            <td class="${stock.changePercent >= 0 ? 'price-up' : 'price-down'}">
                                ${stock.changePercent.toFixed(2)}%
                            </td>
                            <td>${stock.turnoverRate.toFixed(2)}%</td>
                            <td>${stock.pe?.toFixed(2) || '-'}</td>
                            <td>${stock.pb?.toFixed(2) || '-'}</td>
                            <td>${(stock.volume / 10000).toFixed(2)}ä¸‡æ‰‹</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('screenResults').innerHTML = html;
            } catch (error) {
                document.getElementById('screenResults').innerHTML = '<p>æŸ¥è¯¢å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // åŠ è½½æ–°é—»
        async function loadNews() {
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                const response = await fetch(`${API_BASE}/api/news/latest?count=50`);
                const news = await response.json();
                
                if (news && news.length > 0) {
                    displayNews(news);
                } else {
                    // å¦‚æœæ²¡æœ‰æ–°é—»æ•°æ®ï¼Œå°è¯•è‡ªåŠ¨æŠ“å–
                    await fetchLatestNews();
                }
            } catch (error) {
                document.getElementById('newsList').innerHTML = '<p>åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
        function displayNews(news) {
            let html = '';
            if (news && news.length > 0) {
                news.forEach(item => {
                    const stockCodes = item.stockCodes ? item.stockCodes.join(', ') : '';
                    const content = item.content || item.title;
                    html += `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openNewsDetail('${item.id}')">
                            <strong style="color: #667eea; font-size: 1.1em;">${item.title}</strong>
                            <p style="color: #666; margin-top: 8px; font-size: 0.9em; line-height: 1.4;">${content.substring(0, 120)}${content.length > 120 ? '...' : ''}</p>
                            <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #999; font-size: 0.8em;">
                                    ğŸ“° ${item.source} Â· ${new Date(item.publishTime).toLocaleString()}
                                    ${stockCodes ? ' Â· ğŸ“ˆ ' + stockCodes : ''}
                                </span>
                                <span style="color: #999; font-size: 0.8em;">ğŸ‘ï¸ ${item.viewCount || 0}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p style="padding: 20px; text-align: center; color: #999;">æš‚æ— æ–°é—»æ•°æ®ï¼Œè¯·ç‚¹å‡»"æŠ“å–æœ€æ–°æ–°é—»"æŒ‰é’®è·å–æœ€æ–°é‡‘èæ¶ˆæ¯</p>';
            }
            
            document.getElementById('newsList').innerHTML = html;
        }
        
        // æœç´¢æ–°é—»
        async function searchNews() {
            const keyword = document.getElementById('newsSearch').value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
                const response = await fetch(`${API_BASE}/api/news/search?keyword=${encodeURIComponent(keyword)}`);
                const news = await response.json();
                
                displayNews(news);
            } catch (error) {
                document.getElementById('newsList').innerHTML = '<p>æœç´¢å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // æŠ“å–æœ€æ–°æ–°é—»
        async function fetchLatestNews() {
            try {
                document.getElementById('newsList').innerHTML = '<div class="loading">æ­£åœ¨ä»å¤©è¡Œæ•°æ®å’Œæ–°æµªè´¢ç»æŠ“å–æœ€æ–°æ–°é—»...</div>';
                
                const response = await fetch(`${API_BASE}/api/news/fetch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'æ–°é—»æŠ“å–ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹');
                    
                    // ç­‰å¾…2ç§’ååˆ·æ–°æ–°é—»åˆ—è¡¨
                    setTimeout(() => {
                        loadNews();
                    }, 2000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                document.getElementById('newsList').innerHTML = '<p>æŠ“å–å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // æ‰“å¼€æ–°é—»è¯¦æƒ…ï¼ˆå ä½å‡½æ•°ï¼Œå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
        function openNewsDetail(newsId) {
            alert('æ–°é—»è¯¦æƒ…åŠŸèƒ½å¾…å¼€å‘ï¼Œæ–°é—»ID: ' + newsId);
            // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ‰“å¼€æ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæ•´æ–°é—»å†…å®¹
        }
        
        // æ›´æ–°æ–°é—»åˆ·æ–°è®¾ç½®
        async function updateNewsRefreshSettings() {
            const intervalMinutes = document.getElementById('newsRefreshInterval').value;
            const enabled = document.getElementById('enableNewsAutoRefresh').checked;
            
            try {
                const response = await fetch(`${API_BASE}/api/news/refresh-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        intervalMinutes: parseInt(intervalMinutes),
                        enabled: enabled
                    })
                });
                
                if (response.ok) {
                    alert('æ–°é—»åˆ·æ–°è®¾ç½®å·²æ›´æ–°ï¼');
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å¼ºåˆ¶ç«‹å³åˆ·æ–°æ–°é—»
        async function forceRefreshNews() {
            try {
                const response = await fetch(`${API_BASE}/api/news/fetch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('æ–°é—»åˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨åæŸ¥çœ‹æ–°é—»é¡µé¢');
                    
                    // ç­‰å¾…3ç§’ååˆ·æ–°æ–°é—»åˆ—è¡¨
                    setTimeout(() => {
                        if (document.getElementById('news').classList.contains('active')) {
                            loadNews();
                        }
                    }, 3000);
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                alert('åˆ·æ–°å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½æ–°é—»åˆ·æ–°è®¾ç½®
        async function loadNewsRefreshSettings() {
            try {
                const response = await fetch(`${API_BASE}/api/news/refresh-settings`);
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('newsRefreshInterval').value = settings.intervalMinutes || 30;
                    document.getElementById('enableNewsAutoRefresh').checked = settings.enabled !== false;
                }
            } catch (error) {
                console.error('åŠ è½½æ–°é—»åˆ·æ–°è®¾ç½®å¤±è´¥ï¼š', error);
            }
        }
        
        // AIåˆ†æ
        async function analyzeStock() {
            const stockCode = document.getElementById('aiStockCode').value.trim();
            if (!stockCode) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            try {
                document.getElementById('aiResult').textContent = 'åˆ†æä¸­...';
                const response = await fetch(`${API_BASE}/api/ai/analyze/${stockCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify("")
                });
                const result = await response.text();
                document.getElementById('aiResult').textContent = result;
            } catch (error) {
                document.getElementById('aiResult').textContent = 'åˆ†æå¤±è´¥ï¼š' + error.message;
            }
        }
        
        // åˆ›å»ºæé†’
        async function createAlert() {
            const stockCode = document.getElementById('alertStockCode').value.trim();
            const targetPrice = parseFloat(document.getElementById('alertPrice').value);
            const type = document.getElementById('alertType').value;
            
            if (!stockCode || !targetPrice) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/alert/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stockCode, targetPrice, type })
                });
                
                if (response.ok) {
                    alert('åˆ›å»ºæˆåŠŸï¼');
                    document.getElementById('alertStockCode').value = '';
                    document.getElementById('alertPrice').value = '';
                    loadAlerts();
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + await response.text());
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½æé†’
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/alert/active`);
                const alerts = await response.json();
                
                let html = '<table><thead><tr><th>è‚¡ç¥¨ä»£ç </th><th>ç›®æ ‡ä»·</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                
                alerts.forEach(alert => {
                    html += `
                        <tr>
                            <td>${alert.stockCode}</td>
                            <td>${alert.targetPrice.toFixed(2)}</td>
                            <td>${getAlertTypeName(alert.type)}</td>
                            <td>${alert.isTriggered ? 'å·²è§¦å‘' : 'å¾…è§¦å‘'}</td>
                            <td>${new Date(alert.createTime).toLocaleString()}</td>
                            <td><button class="btn btn-danger" onclick="deleteAlert(${alert.id})">åˆ é™¤</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                document.getElementById('alertsList').innerHTML = html || '<p>æš‚æ— æé†’</p>';
            } catch (error) {
                document.getElementById('alertsList').innerHTML = '<p>åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        function getAlertTypeName(type) {
            const types = {
                'PriceUp': 'ä»·æ ¼ä¸Šæ¶¨',
                'PriceDown': 'ä»·æ ¼ä¸‹è·Œ',
                'PriceReach': 'åˆ°è¾¾ä»·æ ¼'
            };
            return types[type] || type;
        }
        
        function removeStock(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
                fetch(`${API_BASE}/api/watchlist/${id}`, { method: 'DELETE' })
                    .then(() => loadWatchlist());
            }
        }
        
        function deleteAlert(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
                fetch(`${API_BASE}/api/alert/${id}`, { method: 'DELETE' })
                    .then(() => loadAlerts());
            }
        }
        
        // åˆ·æ–°è‡ªé€‰è‚¡
        async function refreshWatchlist() {
            const watchlistList = document.getElementById('watchlistList');
            watchlistList.innerHTML = '<div class="loading">åˆ·æ–°ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('åˆ·æ–°åçš„è‡ªé€‰è‚¡æ•°æ®ï¼š', data);
                
                let html = '';
                if (!data || Object.keys(data).length === 0) {
                    html = '<p style="padding: 20px; color: #999; text-align: center;">æš‚æ— è‡ªé€‰è‚¡ï¼Œè¯·æ·»åŠ è‚¡ç¥¨</p>';
                } else {
                    for (const [category, stocks] of Object.entries(data)) {
                        html += `<h4 style="margin-top: 20px; color: #667eea; font-size: 1.2em; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">${category}</h4>`;
                        html += '<div class="stock-cards">';
                        
                        // æ‰¹é‡åˆ·æ–°è‚¡ç¥¨è¡Œæƒ…
                        for (const stock of stocks) {
                            try {
                                await fetch(`${API_BASE}/api/stock/${stock.stockCode}`);
                            } catch (e) {
                                console.error('åˆ·æ–°è‚¡ç¥¨è¡Œæƒ…å¤±è´¥ï¼š', stock.stockCode, e);
                            }
                        }
                        
                        // é‡æ–°è·å–æ›´æ–°åçš„æ•°æ®
                        const updatedResponse = await fetch(`${API_BASE}/api/watchlist/grouped`);
                        const updatedData = await updatedResponse.json();
                        const categoryStocks = updatedData[category] || stocks;
                        
                        categoryStocks.forEach(stock => {
                            const profitClass = (stock.profitLoss || 0) >= 0 ? 'price-up' : 'price-down';
                            const stockData = stock.stock || {};
                            const currentPrice = stockData.currentPrice || 0;
                            const changePercent = stockData.changePercent || 0;
                            const isPositive = changePercent >= 0;
                            const categoryColor = stock.category?.color || '#667eea';
                            
                            html += `
                                <div class="stock-card">
                                    <div class="category-label" style="background: ${categoryColor}20; color: ${categoryColor};">
                                        ${category}
                                    </div>
                                    <div class="stock-header">
                                        <div class="stock-name-section">
                                            <div class="stock-name">${stockData.name || 'N/A'}</div>
                                            <div class="stock-code">${stock.stockCode}</div>
                                        </div>
                                        <div class="stock-actions">
                                            <button class="btn btn-small" onclick="openAI('${stock.stockCode}')">AIåˆ†æ</button>
                                            <button class="btn btn-danger btn-small" onclick="removeStock(${stock.id})">åˆ é™¤</button>
                                        </div>
                                    </div>
                                    <div class="price-section">
                                        <div class="current-price ${isPositive ? 'price-up' : 'price-down'}">
                                            ${currentPrice.toFixed(2)}
                                        </div>
                                        <div class="price-info-row">
                                            <div>
                                                <span class="${isPositive ? 'price-up' : 'price-down'}">
                                                    ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                                                </span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">æœ€é«˜</span>
                                                <span class="price-value">${stockData.highPrice ? stockData.highPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">æœ€ä½</span>
                                                <span class="price-value">${stockData.lowPrice ? stockData.lowPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="price-info-row">
                                            <div class="price-item">
                                                <span class="price-label">æ˜¨æ”¶</span>
                                                <span class="price-value">${stockData.closePrice ? stockData.closePrice.toFixed(2) : (stockData.prevClose ? stockData.prevClose.toFixed(2) : 'N/A')}</span>
                                            </div>
                                            <div class="price-item">
                                                <span class="price-label">ä»Šå¼€</span>
                                                <span class="price-value">${stockData.openPrice ? stockData.openPrice.toFixed(2) : 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="market-info">
                                        <div style="color: #666;">
                                            æˆäº¤é‡: ${stockData.volume ? (stockData.volume / 10000).toFixed(2) + 'ä¸‡' : 'N/A'}
                                        </div>
                                        <div class="cost-info ${stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative'}">
                                            æˆæœ¬: ${stock.costPrice ? stock.costPrice.toFixed(2) : '-'} Ã— ${stock.quantity || '-'}<br>
                                            ç›ˆäº: <strong>${stock.profitLoss !== undefined ? stock.profitLoss.toFixed(2) : '-'}</strong>
                                            (${stock.profitLossPercent !== undefined ? stock.profitLossPercent.toFixed(2) : '-'}%)
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                }
                
                watchlistList.innerHTML = html;
                updateLastRefreshTime(); // æ›´æ–°åˆ·æ–°æ—¶é—´
            } catch (error) {
                watchlistList.innerHTML = '<p>åˆ·æ–°å¤±è´¥ï¼š' + error.message + '</p>';
            }
        }
        
        // æ‰“å¼€AIåˆ†æ
        function openAI(stockCode) {
            // åˆ‡æ¢åˆ°AIåˆ†ææ ‡ç­¾
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector('.tab:nth-child(4)').classList.add('active');
            document.getElementById('ai').classList.add('active');
            
            // è®¾ç½®è‚¡ç¥¨ä»£ç 
            document.getElementById('aiStockCode').value = stockCode;
            
            // è‡ªåŠ¨åˆ†æ
            analyzeStock();
        }
        
        // æ˜¾ç¤ºåˆ›å»ºåˆ†ç±»å¯¹è¯æ¡†
        function showCreateCategory() {
            document.getElementById('createCategoryModal').style.display = 'flex';
        }
        
        // éšè—åˆ›å»ºåˆ†ç±»å¯¹è¯æ¡†
        function hideCreateCategory() {
            document.getElementById('createCategoryModal').style.display = 'none';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryDesc').value = '';
            document.getElementById('categoryColor').value = '#1890ff';
        }
        
        // åˆ›å»ºåˆ†ç±»
        async function createCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const desc = document.getElementById('categoryDesc').value.trim();
            const color = document.getElementById('categoryColor').value;
            
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc, color })
                });
                
                if (response.ok) {
                    alert('åˆ†ç±»åˆ›å»ºæˆåŠŸï¼');
                    hideCreateCategory();
                    loadCategories(); // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + await response.text());
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/categories`);
                const categories = await response.json();
                
                let html = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
                if (categories.length === 0) {
                    html += '<option value="" disabled>æš‚æ— åˆ†ç±»ï¼Œè¯·å…ˆåˆ›å»ºåˆ†ç±»</option>';
                } else {
                    categories.forEach(cat => {
                        html += `<option value="${cat.id}" style="background: ${cat.color}20;">${cat.name}</option>`;
                    });
                }
                
                document.getElementById('categorySelect').innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥ï¼š', error);
                document.getElementById('categorySelect').innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
            }
        }
        
        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å‡½æ•°
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            if (autoRefreshEnabled) {
                autoRefreshTimer = setInterval(() => {
                    if (document.getElementById('watchlist').classList.contains('active')) {
                        refreshStockCards(); // åªåˆ·æ–°å¡ç‰‡æ•°æ®ï¼Œä¸é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
                    }
                }, autoRefreshInterval * 1000);
            }
        }
        
        // åªåˆ·æ–°è‚¡ç¥¨å¡ç‰‡æ•°æ®ï¼Œä¸é‡æ–°åŠ è½½æ•´ä¸ªé¡µé¢
        async function refreshStockCards() {
            try {
                const response = await fetch(`${API_BASE}/api/watchlist/grouped`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                for (const [category, stocks] of Object.entries(data)) {
                    for (const stock of stocks) {
                        const stockData = stock.stock || {};
                        const cardId = `card-${stock.stockCode}`;
                        const card = document.getElementById(cardId);
                        
                        if (card) {
                            // æ›´æ–°ä»·æ ¼
                            const currentPriceEl = card.querySelector('.current-price');
                            if (currentPriceEl) {
                                const price = stockData.currentPrice || 0;
                                const changePercent = stockData.changePercent || 0;
                                const isPositive = changePercent >= 0;
                                currentPriceEl.textContent = price.toFixed(2);
                                currentPriceEl.className = `current-price ${isPositive ? 'price-up' : 'price-down'}`;
                            }
                            
                            // æ›´æ–°æ¶¨è·Œå¹…
                            const changePercentEl = card.querySelector('.price-info-row > div > span');
                            if (changePercentEl && stockData.changePercent !== undefined) {
                                const changePercent = stockData.changePercent || 0;
                                changePercentEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                                changePercentEl.className = changePercent >= 0 ? 'price-up' : 'price-down';
                            }
                            
                            // æ›´æ–°å…¶ä»–ä»·æ ¼ä¿¡æ¯
                            const priceItems = card.querySelectorAll('.price-item .price-value');
                            if (priceItems.length >= 4) {
                                // æ›´æ–°æœ€é«˜ä»·
                                if (stockData.highPrice !== undefined) {
                                    priceItems[0].textContent = stockData.highPrice.toFixed(2);
                                }
                                // æ›´æ–°æœ€ä½ä»·
                                if (stockData.lowPrice !== undefined) {
                                    priceItems[1].textContent = stockData.lowPrice.toFixed(2);
                                }
                                // æ›´æ–°ä»Šå¼€ä»·
                                if (stockData.openPrice !== undefined) {
                                    priceItems[2].textContent = stockData.openPrice.toFixed(2);
                                }
                                // æ›´æ–°æ˜¨æ”¶ä»·
                                const closePrice = stockData.closePrice !== undefined ? stockData.closePrice : stockData.prevClose;
                                if (closePrice !== undefined) {
                                    priceItems[3].textContent = closePrice.toFixed(2);
                                }
                            }
                            
                            // æ›´æ–°ç›ˆäº
                            if (stock.profitLoss !== undefined) {
                                const costInfoEl = card.querySelector('.cost-info');
                                if (costInfoEl) {
                                    const profitClass = stock.profitLoss >= 0 ? 'cost-positive' : 'cost-negative';
                                    costInfoEl.className = `cost-info ${profitClass}`;
                                    
                                    const profitStrong = costInfoEl.querySelector('strong');
                                    if (profitStrong) {
                                        profitStrong.textContent = stock.profitLoss.toFixed(2);
                                    }
                                    
                                    const profitPercent = costInfoEl.textContent.match(/\(([^)]+)\)$/);
                                    if (stock.profitLossPercent !== undefined && profitStrong) {
                                        const parent = profitStrong.parentElement;
                                        if (parent) {
                                            parent.textContent = parent.textContent.replace(/\([^)]+\)/, `(${stock.profitLossPercent.toFixed(2)}%)`);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                updateLastRefreshTime();
            } catch (error) {
                console.error('åˆ·æ–°è‚¡ç¥¨å¡ç‰‡å¤±è´¥ï¼š', error);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('toggleRefreshBtn');
            const status = document.getElementById('refreshStatus');
            
            if (autoRefreshEnabled) {
                btn.innerHTML = 'â¸ï¸ æš‚åœ';
                status.textContent = 'å·²å¯ç”¨';
                status.style.color = '#4caf50';
                startAutoRefresh();
            } else {
                btn.innerHTML = 'â–¶ï¸ ç»§ç»­';
                status.textContent = 'å·²æš‚åœ';
                status.style.color = '#f44336';
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                }
            }
        }
        
        function saveSettings() {
            autoRefreshInterval = parseFloat(document.getElementById('autoRefreshInterval').value);
            autoRefreshEnabled = document.getElementById('enableAutoRefresh').checked;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('refreshInterval').textContent = autoRefreshInterval;
            document.getElementById('currentInterval').textContent = autoRefreshInterval + 'ç§’';
            document.getElementById('currentStatus').textContent = autoRefreshEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            document.getElementById('currentStatus').style.color = autoRefreshEnabled ? '#4caf50' : '#f44336';
            
            // é‡å¯è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('autoRefreshInterval', autoRefreshInterval);
            localStorage.setItem('autoRefreshEnabled', autoRefreshEnabled);
            
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadSettings() {
            const savedInterval = localStorage.getItem('autoRefreshInterval');
            const savedEnabled = localStorage.getItem('autoRefreshEnabled');
            
            if (savedInterval) {
                autoRefreshInterval = parseFloat(savedInterval);
                document.getElementById('autoRefreshInterval').value = autoRefreshInterval;
                document.getElementById('refreshInterval').textContent = autoRefreshInterval;
                document.getElementById('currentInterval').textContent = autoRefreshInterval + 'ç§’';
            }
            
            if (savedEnabled !== null) {
                autoRefreshEnabled = savedEnabled === 'true';
                document.getElementById('enableAutoRefresh').checked = autoRefreshEnabled;
                if (!autoRefreshEnabled) {
                    document.getElementById('toggleRefreshBtn').innerHTML = 'â–¶ï¸ ç»§ç»­';
                    document.getElementById('refreshStatus').textContent = 'å·²æš‚åœ';
                    document.getElementById('refreshStatus').style.color = '#f44336';
                    document.getElementById('currentStatus').textContent = 'å·²ç¦ç”¨';
                    document.getElementById('currentStatus').style.color = '#f44336';
                }
            }
        }
        
        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('lastRefreshTime').textContent = timeStr;
        }
        
        // AIæ¨¡å‹é…ç½®ç®¡ç†
        class AIConfigManager {
            constructor() {
                this.configs = [];
                this.apiBase = window.location.origin;
            }

            // åˆå§‹åŒ–
            async init() {
                await this.loadConfigs();
                this.renderConfigList();
            }

            // åŠ è½½æ‰€æœ‰é…ç½®
            async loadConfigs() {
                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig`);
                    if (response.ok) {
                        this.configs = await response.json();
                    } else {
                        console.error('åŠ è½½AIæ¨¡å‹é…ç½®å¤±è´¥:', await response.text());
                    }
                } catch (error) {
                    console.error('åŠ è½½AIæ¨¡å‹é…ç½®å¤±è´¥:', error);
                }
            }

            // æ¸²æŸ“é…ç½®åˆ—è¡¨
            renderConfigList() {
                const container = document.getElementById('aiConfigList');
                if (!container) return;

                if (this.configs.length === 0) {
                    container.innerHTML = '<p style="padding: 20px; color: #999; text-align: center;">æš‚æ— AIæ¨¡å‹é…ç½®ï¼Œè¯·æ·»åŠ é…ç½®</p>';
                    return;
                }

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>åç§°</th>
                                <th>æ¨¡å‹åç§°</th>
                                <th>è®¢é˜…ç«¯ç‚¹</th>
                                <th>çŠ¶æ€</th>
                                <th>é»˜è®¤</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                this.configs.forEach(config => {
                    html += `
                        <tr>
                            <td>${config.name}</td>
                            <td>${config.modelName || '-'}</td>
                            <td>${config.subscribeEndpoint}</td>
                            <td>
                                <span class="${config.isActive ? 'status-active' : 'status-inactive'}">
                                    ${config.isActive ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}
                                </span>
                            </td>
                            <td>
                                ${config.isDefault ? 'âœ“' : ''}
                            </td>
                            <td>
                                <button class="btn btn-small" onclick="aiConfigManager.editConfig(${config.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-small" onclick="aiConfigManager.deleteConfig(${config.id})">åˆ é™¤</button>
                                <button class="btn btn-small" onclick="aiConfigManager.testConfig(${config.id})">æµ‹è¯•</button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;
            }

            // æ˜¾ç¤ºåˆ›å»ºé…ç½®è¡¨å•
            showCreateForm() {
                this.showConfigForm({
                    id: 0,
                    name: '',
                    apiKey: '',
                    subscribeEndpoint: '',
                    modelName: '',
                    isActive: false,
                    isDefault: false
                });
            }

            // æ˜¾ç¤ºç¼–è¾‘é…ç½®è¡¨å•
            showConfigForm(config) {
                const form = document.getElementById('aiConfigForm');
                if (!form) return;

                document.getElementById('configId').value = config.id;
                document.getElementById('configName').value = config.name;
                document.getElementById('configApiKey').value = config.apiKey;
                document.getElementById('configSubscribeEndpoint').value = config.subscribeEndpoint;
                document.getElementById('configModelName').value = config.modelName || '';
                document.getElementById('configIsActive').checked = config.isActive;
                document.getElementById('configIsDefault').checked = config.isDefault;

                // è®¾ç½®è¡¨å•æ ‡é¢˜
                document.getElementById('formTitle').textContent = config.id === 0 ? 'æ·»åŠ æ–°é…ç½®' : 'ç¼–è¾‘é…ç½®';
                
                form.style.display = 'block';
            }

            // ä¿å­˜é…ç½®
            async saveConfig() {
                const config = {
                    id: parseInt(document.getElementById('configId').value),
                    name: document.getElementById('configName').value.trim(),
                    apiKey: document.getElementById('configApiKey').value.trim(),
                    subscribeEndpoint: document.getElementById('configSubscribeEndpoint').value.trim(),
                    modelName: document.getElementById('configModelName').value.trim(),
                    isActive: document.getElementById('configIsActive').checked,
                    isDefault: document.getElementById('configIsDefault').checked
                };

                if (!config.name || !config.apiKey || !config.subscribeEndpoint) {
                    alert('è¯·å¡«å†™å¿…å¡«å­—æ®µ');
                    return;
                }

                try {
                    let response;
                    if (config.id === 0) {
                        // åˆ›å»ºæ–°é…ç½®
                        response = await fetch(`${this.apiBase}/api/aimodelconfig`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                    } else {
                        // æ›´æ–°é…ç½®
                        response = await fetch(`${this.apiBase}/api/aimodelconfig/${config.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                    }

                    if (response.ok) {
                        this.hideConfigForm();
                        await this.loadConfigs();
                        this.renderConfigList();
                        alert('ä¿å­˜æˆåŠŸï¼');
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + await response.text());
                    }
                } catch (error) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                }
            }

            // ç¼–è¾‘é…ç½®
            async editConfig(id) {
                const config = this.configs.find(c => c.id === id);
                if (config) {
                    this.showConfigForm(config);
                }
            }

            // åˆ é™¤é…ç½®
            async deleteConfig(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await this.loadConfigs();
                        this.renderConfigList();
                        alert('åˆ é™¤æˆåŠŸï¼');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + await response.text());
                    }
                } catch (error) {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                }
            }

            // æµ‹è¯•é…ç½®è¿æ¥
            async testConfig(id) {
                const config = this.configs.find(c => c.id === id);
                if (!config) return;

                // æ„é€ æµ‹è¯•è¯·æ±‚å¯¹è±¡ï¼ŒåªåŒ…å«å¿…è¦å­—æ®µ
                const testRequest = {
                    apiKey: config.apiKey,
                    subscribeEndpoint: config.subscribeEndpoint,
                    modelName: config.modelName
                };

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testRequest)
                    });

                    if (response.ok) {
                        alert('è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                    } else {
                        alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + await response.text());
                    }
                } catch (error) {
                    alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
                }
            }

            // å–æ¶ˆç¼–è¾‘
            cancelEdit() {
                this.hideConfigForm();
            }

            // éšè—é…ç½®è¡¨å•
            hideConfigForm() {
                const form = document.getElementById('aiConfigForm');
                if (form) {
                    form.style.display = 'none';
                }
            }

            // æµ‹è¯•è¿æ¥
            async testConnection() {
                const config = {
                    apiKey: document.getElementById('configApiKey').value.trim(),
                    subscribeEndpoint: document.getElementById('configSubscribeEndpoint').value.trim(),
                    modelName: document.getElementById('configModelName').value.trim()
                };

                if (!config.apiKey || !config.subscribeEndpoint || !config.modelName) {
                    alert('è¯·å¡«å†™API Keyã€è®¢é˜…ç«¯ç‚¹å’Œæ¨¡å‹åç§°');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBase}/api/aimodelconfig/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        alert('è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                    } else {
                        alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + await response.text());
                    }
                } catch (error) {
                    alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        // åˆå§‹åŒ–AIé…ç½®ç®¡ç†å™¨
        const aiConfigManager = new AIConfigManager();

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadSettings();
            loadCategories();
            loadWatchlist();
            startAutoRefresh();
            updateLastRefreshTime();
            
            // åˆå§‹åŒ–AIé…ç½®ç®¡ç†å™¨
            aiConfigManager.init();
        };
    </script>
</body>
</html>

