<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票分析系统</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 股票分析系统</h1>
            <p>实时行情 · 技术分析 · 智能推荐</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('watchlist')">自选股</div>
            <div class="tab" onclick="switchTab('screen')">条件选股</div>
            <div class="tab" onclick="switchTab('quant')">📊 量化交易</div>
            <div class="tab" onclick="switchTab('news')">金融新闻</div>
            <div class="tab" onclick="switchTab('ai')">AI分析</div>
            <div class="tab" onclick="switchTab('alert')">价格提醒</div>
            <div class="tab" onclick="switchTab('settings')">⚙️ 设置</div>
        </div>
        
        <!-- 自选股 -->
        <div id="watchlist" class="content active">
            <div class="card">
                <h3>添加自选股</h3>
                <div class="form-group">
                    <label>股票代码（如：000001）</label>
                    <input type="text" id="stockCode" placeholder="输入股票代码">
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="categorySelect" style="flex: 1;">
                            <option value="">加载中...</option>
                        </select>
                        <button class="btn" onclick="showCreateCategory()">+ 新建分类</button>
                    </div>
                </div>
                <button class="btn" onclick="addToWatchlist()">添加到自选股</button>
            </div>
            
            <!-- 创建分类对话框 -->
            <div id="createCategoryModal" class="modal">
                <div class="card modal-card">
                    <h3 style="margin-bottom: 20px;">创建新分类</h3>
                    <div class="form-group">
                        <label>分类名称 *</label>
                        <input type="text" id="categoryName" placeholder="如：已购、预购、关注">
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <input type="text" id="categoryDesc" placeholder="分类描述（可选）">
                    </div>
                    <div class="form-group">
                        <label>颜色</label>
                        <input type="color" id="categoryColor" value="#1890ff">
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="createCategory()">创建</button>
                        <button class="btn btn-secondary" onclick="hideCreateCategory()">取消</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 style="margin: 0;">我的自选股</h3>
                        <p class="refresh-info">
                            自动刷新: <span id="refreshStatus">已启用</span> | 
                            间隔: <span id="refreshInterval">3</span>秒
                        </p>
                    </div>
                    <button class="btn" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">⏸️ 暂停</button>
                </div>
                <div id="watchlistList" class="loading">加载中...</div>
            </div>
        </div>
        
        <!-- 条件选股 -->
        <div id="screen" class="content">
            <div class="card">
                <h3>选股条件模板</h3>
                <div class="template-controls">
                    <select id="templateSelect">
                        <option value="">选择模板...</option>
                    </select>
                    <button class="btn btn-success" onclick="loadTemplate()">📂 加载</button>
                    <button class="btn btn-info" onclick="showSaveTemplateDialog()">💾 保存</button>
                    <button class="btn btn-warning" onclick="editTemplate()">✏️ 编辑</button>
                    <button class="btn btn-danger" onclick="deleteTemplate()">🗑️ 删除</button>
                </div>
            </div>
            
            <div class="card">
                <h3>设置选股条件</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>市场</label>
                        <select id="market">
                            <option value="">全部市场</option>
                            <option value="SH">上海市场</option>
                            <option value="SZ">深圳市场</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>价格区间（元）</label>
                        <input type="number" id="minPrice" placeholder="最低价">
                        <input type="number" id="maxPrice" placeholder="最高价" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>涨跌幅（%）</label>
                        <input type="number" id="minChange" placeholder="最低涨幅">
                        <input type="number" id="maxChange" placeholder="最高涨幅" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>换手率（%）</label>
                        <input type="number" id="minTurnover" placeholder="最低换手率">
                        <input type="number" id="maxTurnover" placeholder="最高换手率" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>市盈率（PE）</label>
                        <input type="number" id="minPE" placeholder="最低PE">
                        <input type="number" id="maxPE" placeholder="最高PE" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>市净率（PB）</label>
                        <input type="number" id="minPB" placeholder="最低PB">
                        <input type="number" id="maxPB" placeholder="最高PB" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>成交量（手）</label>
                        <input type="number" id="minVolume" placeholder="最低成交量">
                        <input type="number" id="maxVolume" placeholder="最高成交量" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>市值区间（万元）</label>
                        <input type="number" id="minMarketValue" placeholder="最低市值">
                        <input type="number" id="maxMarketValue" placeholder="最高市值" class="second-input">
                    </div>
                    <div class="form-group">
                        <label>股息率（%）</label>
                        <input type="number" id="minDividendYield" placeholder="最低股息率">
                        <input type="number" id="maxDividendYield" placeholder="最高股息率" class="second-input">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn" onclick="screenStocks()">🔍 开始选股</button>
                    <button class="btn btn-secondary" onclick="clearConditions()">🧹 清空条件</button>
                </div>
            </div>
            
            <div class="card">
                <h3>选股结果</h3>
                <div id="screenResults" class="loading">等待查询...</div>
            </div>
        </div>
        
        <!-- 量化交易 -->
        <div id="quant" class="content">
            <!-- 策略管理 -->
            <div class="card">
                <h3>📊 策略管理</h3>
                <div class="strategy-controls">
                    <button class="btn" onclick="quantTrading.loadStrategies()">🔄 刷新策略</button>
                    <button class="btn btn-success" onclick="quantTrading.importDefaultStrategies()">📥 导入默认策略</button>
                    <button class="btn btn-info" onclick="quantTrading.showCreateStrategy()">➕ 创建策略</button>
                </div>
                <div id="strategyList" class="loading">加载中...</div>
            </div>

            <!-- 策略配置 -->
            <div class="card">
                <h3>⚙️ 策略配置</h3>
                <div class="form-group">
                    <label>选择策略</label>
                    <select id="strategySelect" onchange="quantTrading.loadStrategyConfig()">
                        <option value="">请选择策略...</option>
                    </select>
                </div>
                <div id="strategyConfigForm" class="hidden">
                    <div class="form-group">
                        <label>策略名称</label>
                        <input type="text" id="strategyName" placeholder="策略名称">
                    </div>
                    <div class="form-group">
                        <label>策略描述</label>
                        <textarea id="strategyDescription" rows="3" placeholder="策略描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label>初始资金（元）</label>
                        <input type="number" id="initialCapital" value="100000" min="1000">
                    </div>
                    <div class="form-group">
                        <label>策略类型</label>
                        <select id="strategyType" onchange="quantTrading.loadStrategyParameters(this.value)">
                            <option value="TechnicalIndicator">技术指标策略</option>
                            <option value="Fundamental">基本面策略</option>
                            <option value="Arbitrage">套利策略</option>
                            <option value="MachineLearning">机器学习策略</option>
                            <option value="Custom">自定义策略</option>
                        </select>
                    </div>
                    <div id="strategyParameters">
                        <!-- 动态加载策略参数 -->
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="isActive" checked> 启用策略</label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="quantTrading.saveStrategy()">💾 保存策略</button>
                        <button class="btn btn-warning" onclick="quantTrading.testStrategy()">🧪 测试策略</button>
                        <button class="btn btn-danger" onclick="quantTrading.deleteStrategy()">🗑️ 删除策略</button>
                    </div>
                </div>
            </div>

            <!-- 回测结果 -->
            <div class="card">
                <h3>📈 回测分析</h3>
                
                <!-- 一键回测区域 -->
                <div class="card quick-backtest">
                    <h4>🚀 新手一键回测</h4>
                    <p>无需复杂配置，使用简单移动平均策略快速体验回测功能</p>
                    <div class="quick-backtest-form">
                        <div class="form-group">
                            <label>股票代码</label>
                            <input type="text" id="quickBacktestStock" placeholder="如：000001">
                        </div>
                        <div class="form-group">
                            <label>开始日期</label>
                            <input type="date" id="quickBacktestStartDate">
                        </div>
                        <div class="form-group">
                            <label>结束日期</label>
                            <input type="date" id="quickBacktestEndDate">
                        </div>
                        <button class="btn btn-success" onclick="quantTrading.quickBacktest()">⚡ 一键回测</button>
                    </div>
                    <div id="quickBacktestResult" class="hidden">
                        <div class="result-card">
                            <div id="quickBacktestMessage"></div>
                            <div id="quickBacktestDetails"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>选择股票进行回测</label>
                    <div class="stock-selection">
                        <select id="backtestStockSelect" multiple size="3">
                            <option value="">从自选股选择...</option>
                        </select>
                        <div class="selection-actions">
                            <button class="btn" onclick="quantTrading.addSelectedStockToBacktest()" title="添加选中的股票">➕ 添加</button>
                            <button class="btn btn-danger" onclick="quantTrading.clearBacktestStocks()" title="清空已选股票">❌ 清空</button>
                        </div>
                    </div>
                    <div class="backtest-config">
                        <div class="form-group">
                            <label>已选股票</label>
                            <textarea id="backtestStock" placeholder="输入多个股票代码，用逗号分隔，如：000001,600000"></textarea>
                        </div>
                        <div class="date-config">
                            <div class="form-group">
                                <input type="date" id="backtestStartDate" title="开始日期">
                            </div>
                            <div class="form-group">
                                <input type="date" id="backtestEndDate" title="结束日期">
                            </div>
                            <button class="btn" onclick="quantTrading.runBatchBacktest()">🚀 开始批量回测</button>
                        </div>
                    </div>
                </div>
                <div id="backtestResults" class="hidden">
                    <div id="backtestSummaryList"></div>
                    <div id="backtestDetailPanel" class="hidden">
                        <div class="stats">
                            <div class="stat-card">
                                <h4>总收益率</h4>
                                <div class="value" id="totalReturn">-</div>
                            </div>
                            <div class="stat-card">
                                <h4>年化收益率</h4>
                                <div class="value" id="annualReturn">-</div>
                            </div>
                            <div class="stat-card">
                                <h4>最大回撤</h4>
                                <div class="value" id="maxDrawdown">-</div>
                            </div>
                            <div class="stat-card">
                                <h4>夏普比率</h4>
                                <div class="value" id="sharpeRatio">-</div>
                            </div>
                            <div class="stat-card">
                                <h4>交易次数</h4>
                                <div class="value" id="tradeCount">-</div>
                            </div>
                            <div class="stat-card">
                                <h4>胜率</h4>
                                <div class="value" id="winRate">-</div>
                            </div>
                        </div>
                        <div class="trade-history">
                            <h4>交易记录</h4>
                            <div id="tradeHistory"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 实时监控 -->
            <div class="card">
                <h3>📡 实时监控</h3>
                <div class="monitoring-controls">
                    <button class="btn" onclick="quantTrading.startMonitoring()" id="startMonitorBtn">▶️ 开始监控</button>
                    <button class="btn btn-danger" onclick="quantTrading.stopMonitoring()" id="stopMonitorBtn">⏹️ 停止监控</button>
                    <button class="btn" onclick="quantTrading.loadActiveStrategies()">🔄 刷新活跃策略</button>
                </div>
                <div id="monitoringStatus" class="loading">监控已停止</div>
                <div id="activeStrategies"></div>
            </div>
        </div>
        
        <!-- 金融新闻 -->
        <div id="news" class="content">
            <div class="card">
                <h3>最新金融新闻</h3>
                <div class="news-controls">
                    <input type="text" id="newsSearch" placeholder="搜索新闻关键词">
                    <button class="btn" onclick="searchNews()">🔍 搜索</button>
                    <button class="btn" onclick="fetchLatestNews()">🔄 抓取最新新闻</button>
                    <button class="btn" onclick="analyzeBatchNews()">🤖 批量AI分析</button>
                </div>
                <div id="batchAnalysisResult" class="hidden">
                    <h4>📊 市场综合分析</h4>
                    <div id="batchAnalysisContent"></div>
                    <div class="analysis-footer">
                        <span id="batchAnalysisStats"></span>
                        <button onclick="hideBatchAnalysis()" class="btn-close">✕ 关闭</button>
                    </div>
                </div>
                
                <!-- 提示词选择对话框 -->
                <div id="promptSelectionModal" class="modal">
                    <div class="modal-content prompt-modal">
                        <h3>🤖 选择AI分析提示词</h3>
                        <p>请选择一个提示词来指导AI分析新闻内容：</p>
                        
                        <div id="promptList"></div>
                        
                        <div class="modal-actions">
                            <button onclick="closePromptModal()" class="btn btn-secondary">取消</button>
                            <button id="confirmPromptBtn" onclick="confirmPromptSelection()" class="btn" disabled>开始分析</button>
                        </div>
                    </div>
                </div>
                
                <div id="newsList" class="loading">加载中...</div>
            </div>
        </div>
        
        <!-- AI分析 -->
        <div id="ai" class="content">
            <div class="card">
                <h3>AI股票分析</h3>
                <div class="form-group">
                    <label>股票代码</label>
                    <input type="text" id="aiStockCode" placeholder="输入要分析的股票代码">
                </div>
                <div class="form-group">
                    <label>选择提示词</label>
                    <select id="aiPromptSelect">
                        <option value="">（使用默认或JSON配置）</option>
                    </select>
                </div>
                <button class="btn" onclick="analyzeStock()">开始分析</button>
                <div id="aiResult"></div>
            </div>
        </div>
        
        <!-- 价格提醒 -->
        <div id="alert" class="content">
            <div class="card">
                <h3>创建价格提醒</h3>
                <div class="form-group">
                    <label>股票代码</label>
                    <input type="text" id="alertStockCode" placeholder="输入股票代码">
                </div>
                <div class="form-group">
                    <label>目标价格</label>
                    <input type="number" step="0.01" id="alertPrice" placeholder="输入目标价格">
                </div>
                <div class="form-group">
                    <label>提醒类型</label>
                    <select id="alertType">
                        <option value="PriceUp">价格涨到目标价</option>
                        <option value="PriceDown">价格跌到目标价</option>
                        <option value="PriceReach">价格到达目标价</option>
                    </select>
                </div>
                <button class="btn" onclick="createAlert()">创建提醒</button>
            </div>
            
            <div class="card">
                <h3>活跃提醒</h3>
                <div id="alertsList" class="loading">加载中...</div>
            </div>
        </div>
        
        <!-- 设置 -->
        <div id="settings" class="content">
            <!-- AI提示词配置 -->
            <div class="card">
                <h3>AI提示词配置</h3>
                <div class="form-group">
                    <button class="btn" onclick="aiPromptManager.loadPrompts()">🔄 刷新提示词列表</button>
                    <button class="btn" onclick="aiPromptManager.showCreateForm()">➕ 添加提示词</button>
                </div>
                <div id="aiPromptList" class="loading">加载中...</div>

                <!-- 添加/编辑表单 -->
                <div id="aiPromptForm" class="hidden">
                    <h4 id="promptFormTitle">添加新提示词</h4>
                    <input type="hidden" id="promptId">
                    <div class="form-group">
                        <label>名称 *</label>
                        <input type="text" id="promptName" placeholder="例如：基本面分析">
                    </div>
                    <div class="form-group">
                        <label>系统提示词 *</label>
                        <textarea id="promptText" rows="6" placeholder="输入系统提示词"></textarea>
                    </div>
                    <div class="form-group">
                        <label>温度（0-2）</label>
                        <input type="number" id="promptTemp" step="0.1" min="0" max="2" value="0.7">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="promptIsDefault"> 设为默认提示词</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="promptIsActive" checked> 启用</label>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="aiPromptManager.savePrompt()">💾 保存提示词</button>
                        <button class="btn btn-secondary" onclick="aiPromptManager.cancelEdit()">取消</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>股票行情自动刷新设置</h3>
                <div class="form-group">
                    <label>刷新间隔（秒）</label>
                    <input type="number" id="autoRefreshInterval" min="0.5" max="60" step="0.5" value="3">
                    <p class="help-text">
                        推荐设置：0.5-2秒（实时） | 3-5秒（常规） | 10-30秒（省流量）
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableAutoRefresh" checked>
                        启用自动刷新
                    </label>
                </div>
                <button class="btn" onclick="saveSettings()">💾 保存设置</button>
            </div>
            
            <div class="card">
                <h3>金融消息定时刷新设置</h3>
                <div class="form-group">
                    <label>新闻刷新间隔（分钟）</label>
                    <input type="number" id="newsRefreshInterval" min="5" max="1440" step="5" value="30">
                    <p class="help-text">
                        推荐设置：5-15分钟（高频） | 30-60分钟（常规） | 120分钟以上（低频）
                    </p>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNewsAutoRefresh" checked>
                        启用新闻自动刷新
                    </label>
                </div>
                <div class="form-actions">
                    <button class="btn" onclick="updateNewsRefreshSettings()">💾 更新新闻刷新设置</button>
                    <button class="btn" onclick="forceRefreshNews()">🔄 立即刷新新闻</button>
                </div>
            </div>
            
            <div class="card">
                <h3>当前状态</h3>
                <div class="status-cards">
                    <div class="status-card">
                        <div class="status-label">刷新间隔</div>
                        <div class="status-value" id="currentInterval">3秒</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">自动刷新状态</div>
                        <div class="status-value" id="currentStatus">已启用</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">上次刷新</div>
                        <div class="status-value" id="lastRefreshTime">--</div>
                    </div>
                </div>
            </div>
            
            <!-- AI模型配置 -->
            <div class="card">
                <h3>AI模型配置</h3>
                <div class="form-group">
                    <button class="btn" onclick="aiConfigManager.loadConfigs()">🔄 刷新配置列表</button>
                    <button class="btn" onclick="aiConfigManager.showCreateForm()">➕ 添加配置</button>
                </div>
                
                <!-- 配置列表 -->
                <div id="aiConfigList" class="loading">加载中...</div>
                
                <!-- 添加/编辑表单 -->
                <div id="aiConfigForm" class="hidden">
                    <h4 id="formTitle">添加新配置</h4>
                    <input type="hidden" id="configId">
                    <div class="form-group">
                        <label>配置名称 *</label>
                        <input type="text" id="configName" placeholder="例如：通义千问API">
                    </div>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="password" id="configApiKey" placeholder="请输入API密钥">
                    </div>
                    <div class="form-group">
                        <label>订阅端点 *</label>
                        <input type="text" id="configSubscribeEndpoint" placeholder="例如：https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation">
                    </div>
                    <div class="form-group">
                        <label>模型名称 *</label>
                        <input type="text" id="configModelName" placeholder="例如：qwen-max">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsActive">
                            设为激活状态
                        </label>
                        <p class="help-text">
                            激活状态下，系统将使用此配置进行AI分析
                        </p>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="configIsDefault">
                            设为默认配置
                        </label>
                        <p class="help-text">
                            默认配置将在创建新配置时自动选中
                        </p>
                    </div>
                    <div class="form-actions">
                        <button class="btn" onclick="aiConfigManager.saveConfig()">💾 保存配置</button>
                        <button class="btn btn-secondary" onclick="aiConfigManager.cancelEdit()">取消</button>
                        <button class="btn btn-warning" onclick="aiConfigManager.testConnection()">🧪 测试连接</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 保存选股模板对话框 -->
    <div id="saveTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="saveTemplateTitle">保存选股模板</h3>
                <span class="close" onclick="hideSaveTemplateDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>模板名称 *</label>
                    <input type="text" id="templateName" placeholder="输入模板名称" required>
                </div>
                <div class="form-group">
                    <label>模板描述</label>
                    <textarea id="templateDescription" placeholder="输入模板描述（可选）" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setAsDefault"> 设为默认模板
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveTemplate()">💾 保存</button>
                <button class="btn btn-secondary" onclick="hideSaveTemplateDialog()">取消</button>
            </div>
        </div>
    </div>
    
    <!-- AI分析回测结果对话框 -->
    <div id="aiAnalysisModal" class="modal">
        <div class="modal-content ai-analysis-modal">
            <div class="modal-header">
                <h3>AI分析回测结果</h3>
                <span class="close" onclick="document.getElementById('aiAnalysisModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div id="aiAnalysisLoading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>AI正在分析中，请稍候...</p>
                </div>
                <div id="aiAnalysisResult" class="hidden">
                    <div class="stock-info">
                        <h4 id="aiAnalysisStockCode"></h4>
                        <div class="strategy-info">
                            <span id="aiAnalysisStrategyName"></span>
                            <span id="aiAnalysisDateRange"></span>
                        </div>
                        <div class="ai-settings-info">
                            <span id="aiModelInfo">使用模型: <span id="aiModelName">自动选择</span></span>
                            <span>提示词: <span id="aiPromptName">默认</span></span>
                            <button class="btn btn-small" onclick="showAISettingsModal()">更改设置</button>
                        </div>
                    </div>
                    <div class="analysis-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI设置选择对话框 -->
    <div id="aiSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>AI分析设置</h3>
                <span class="close" onclick="document.getElementById('aiSettingsModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>选择AI模型配置</label>
                    <select id="aiModelSelect">
                        <option value="">使用默认配置</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>选择提示词</label>
                    <select id="aiPromptSelect">
                        <option value="">使用默认提示词</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="applyAISettings()">应用设置</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('aiSettingsModal').style.display='none'">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>